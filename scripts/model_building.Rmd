---
title: "model_building"
output: html_document
theme: united
date: "2025-02-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, fig.width = 10, fig.height = 5)

lapply(list.files("../../pantry/functions/", recursive = T, full.names = T), source)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(knitr)
```

```{r}
analysis <- readRDS("../data/processed/premier_analysis.rda")
model_building <- analysis %>% filter(!is.na(genetic_category.lab))

covariates <- list(age="Age, years", Sex="Sex, female", bmi="BMI, kg/m2", #bmi_cat="BMI Category", 
                whr="Waist-Hip", PC1="Genetic PC1", PC2="Genetic PC2", PC3="Genetic PC3", 
                PC4="Genetic PC4", PC5="Genetic PC5")

genetic_pcs <- c(paste0("PC",1:5))
```


### 1. Check whether genetic PCs are associated with the genetic category exposure
```{r, echo=F}
## Test for covariate associations with primary exposure
sum <- as.data.frame(matrix(NA, 5, 5, dimnames = list(NULL, c("covar", "mean_prefer_carb", "mean_prefer_fat", "t_stat", "p"))))
for(i in 1:5) {
  dat <- model_building %>% select(pc=paste0("PC",i), genetic_category.lab)
  t_test <- t.test(pc~genetic_category.lab, data=dat)
  sum[i,1:5] <- c(paste0("PC",i), t_test$estimate[1], t_test$estimate[2], t_test$statistic, p=t_test$p.value)
} ; sum %>% mutate(across(-"covar", ~round(as.numeric(.),2))) %>% kable()
```

None of the genetic PCs are significantly associated with the genetic category exposure (via t-tests)

### 2. Check whether genetic PCs are associated with fasting or iAUC metabolite outcomes
```{r}
univar_pcs_metabolites <- do.call(rbind.data.frame, lapply(c("fasting", "iauc"), function(type) {
  do.call(rbind.data.frame, lapply(c("glucose", "insulin"), function(m){
  metabolite_type <- ifelse(type == "fasting", m, paste0(m, "_120iauc"))
  #univariate model
  sum <- do.call(rbind.data.frame, lapply(1:length(genetic_pcs), function(i) {
    mod <- summary(lm(formula(paste0(metabolite_type, "~", genetic_pcs[i])), data=model_building))
    coefs <- mod$coef[2,1:2] ; r2 <- mod$r.squared ; p=mod$coef[2,4]
    sum<-as.data.frame(matrix(c(coefs, p, r2),1,4, dimnames=list(NULL, c("beta", "se", "p_val", "r2")))) %>%
      mutate(model="univariate", metabolite=m, type=type, covar=genetic_pcs[i], .before=beta) }))
  sum
  }))
}))

multivar_pcs_metabolites <- do.call(rbind.data.frame, lapply(c("fasting", "iauc"), function(type) {
  do.call(rbind.data.frame, lapply(c("glucose", "insulin"), function(m){
  metabolite_type <- ifelse(type == "fasting", m, paste0(m, "_120iauc"))
  #base model  
  mod_base <- summary(lm(formula(paste0(metabolite_type, "~genetic_category.lab")), data=model_building))
  coefs_base <- mod_base$coef[2,1:2] ; r2_base <- mod_base$r.squared ; p_base=mod_base$coef[2,4]
  sum_base <- as.data.frame(matrix(c(coefs_base, p_base, r2_base),1,4, dimnames=list(NULL, c("beta","se","p_val","r2")))) %>%
    mutate(model="base", metabolite=m, type=type, covar="No adjustment", .before=beta)
  #adj model
  sum_adj <- do.call(rbind.data.frame, lapply(1:length(genetic_pcs), function(i) {
    mod_adj <- summary(lm(formula(paste0(metabolite_type, "~genetic_category.lab+", genetic_pcs[i])), data=model_building))
    coefs_adj <- mod_adj$coef[2,1:2] ; r2_adj <- mod_adj$r.squared ; p_adj=mod_adj$coef[2,4]
    sum_adj<-as.data.frame(matrix(c(coefs_adj, p_adj, r2_adj),1,4, dimnames=list(NULL, c("beta", "se", "p_val", "r2")))) %>%
      mutate(model="adj", metabolite=m, type=type, covar=genetic_pcs[i], .before=beta) }))
  bind_rows(sum_base, sum_adj)
  }))
})) 

# Adding genetic PCs to prior model
genetic_pcs_add <- c("PC1", "PC1+PC2", "PC1+PC2+PC3", "PC1+PC2+PC3+PC4", "PC1+PC2+PC3+PC4+PC5")
multivar_add_pcs_metabolites <- do.call(rbind.data.frame, lapply(c("fasting", "iauc"), function(type) {
  do.call(rbind.data.frame, lapply(c("glucose", "insulin"), function(m){
    metabolite_type <- ifelse(type == "fasting", m, paste0(m, "_120iauc"))
    #base model  
    mod_base <- summary(lm(formula(paste0(metabolite_type, "~genetic_category.lab")), data=model_building))
    coefs_base <- mod_base$coef[2,1:2] ; r2_base <- mod_base$r.squared ; p_base=mod_base$coef[2,4]
    sum_base <- as.data.frame(matrix(c(coefs_base, p_base, r2_base),1,4, dimnames=list(NULL, c("beta","se","p_val","r2")))) %>%
      mutate(model="base", metabolite=m, type=type, covar="No adjustment", .before=beta)
    #adj model
    sum_adj <- do.call(rbind.data.frame, lapply(1:length(genetic_pcs_add), function(i) {
      mod_adj <- summary(lm(formula(paste0(metabolite_type, "~genetic_category.lab+", genetic_pcs_add[i])), data=model_building))
      coefs_adj <- mod_adj$coef[2,1:2] ; r2_adj <- mod_adj$r.squared ; p_adj=mod_adj$coef[2,4]
      sum_adj<-as.data.frame(matrix(c(coefs_adj, p_adj, r2_adj),1,4, dimnames=list(NULL, c("beta", "se", "p_val", "r2")))) %>%
        mutate(model="adj", metabolite=m, type=type, covar=genetic_pcs_add[i], .before=beta) }))
    bind_rows(sum_base, sum_adj)
  }))
})) 

```

#### Univariate associations
##### Model: metabolite ~ PC (estimates shown are for the PC association)
```{r}
# Adjusted model r2 for genetic PCs predicting fasting metabolites & iAUC values
ggarrange(
  univar_pcs_metabolites %>% 
    ggplot(aes(x=covar, y=r2, fill=covar)) + 
    facet_wrap(~type+metabolite, nrow = 2)+
    geom_bar(stat="identity") + 
    scale_fill_manual(values=palettes$NatExt$Purples) + 
    ylab("Univeriate R-squared\nfasting metabolites") + xlab("Genetic PC") + 
    theme_bw()
  )

ggarrange(
  univar_pcs_metabolites %>% 
    ggplot(aes(x=covar, y=-log10(p_val), color=covar)) + 
    facet_wrap(~type+metabolite, nrow = 2)+
    geom_point(size=3) + geom_hline(yintercept = 0) + geom_hline(yintercept = -log10(0.05), color="red")+
    scale_color_manual(values=palettes$NatExt$Purples) + 
    ylab("-log10(P) \nfasting metabolites") + xlab("Genetic PC") + 
    theme_bw() 
  )
```

 - R2: PC3 seems to have a high r2 for fasting glucose and insulin 
 - Pvals (shown on -log10(P) scale): None of the genetic PCs are significantly associated with any of the fasting or iAUC metabolites (all >0.05)


#### Multivariate associations, with genetic category
##### Mmodel: metabolite ~ PC + genetic category
```{r}
ggarrange(
  multivar_pcs_metabolites %>% 
    ggplot(aes(x=covar, y=r2, fill=covar)) + 
    facet_wrap(~type+metabolite, nrow = 2)+
    geom_bar(stat="identity") + 
    scale_fill_manual(values=palettes$NatExt$Blues) + 
    ylab("Univeriate R-squared\nfasting metabolites") + xlab("Genetic PC") + 
    theme_bw()
)

ggarrange(
  multivar_pcs_metabolites %>% 
    ggplot(aes(x=covar, y=-log10(p_val), color=covar)) + 
    facet_wrap(~type+metabolite, nrow = 2)+
    geom_point(size=3) + geom_hline(yintercept = 0) + geom_hline(yintercept = -log10(0.05), color="red")+
    scale_color_manual(values=palettes$NatExt$Blues) + 
    ylab("-log10(P) \nfasting metabolites") + xlab("Genetic PC") + 
    theme_bw() 
  )
```

 - R2 with PC3 expalins mroe variability in fasting glucose & insulin than model without genetic PCs. For iAUC metabolites, seems to be some benefit for including even more PCs (PC4 for glucose; PC5 for insulin)
 - Adding adjustment for gentic PCs (PC4) improves strength of association between genetic category and iAUC metabolites; specifically PC4 (i.e., genetic category + PC4 was significant, while genetic category alone was not). 
 - Note improvements for insulin as well for PC4

#### Multivariate associations with with genetic category and sequential PC adjustment
model: metabolite ~ PC + genetic category (estimates shown are for the adjusted genetic category association)

```{r}
ggarrange(
  multivar_add_pcs_metabolites %>% 
    ggplot(aes(x=covar, y=r2, fill=covar)) + 
    facet_wrap(~type+metabolite, nrow = 2)+
    geom_bar(stat="identity") + 
    scale_fill_manual(values=palettes$NatExt$Greens) + 
    ylab("Univeriate R-squared\nfasting metabolites") + xlab("Genetic PC") + 
    theme_bw()
)

ggarrange(
  multivar_add_pcs_metabolites %>% 
    ggplot(aes(x=covar, y=-log10(p_val), color=covar)) + 
    facet_wrap(~type+metabolite, nrow = 2)+
    geom_point(size=3) + geom_hline(yintercept = 0) + geom_hline(yintercept = -log10(0.05), color="red")+
    scale_color_manual(values=palettes$NatExt$Greens) + 
    ylab("-log10(P) \nfasting metabolites") + xlab("Genetic PC") + 
    theme_bw() 
  )
```

 - sequentially adding genetic PCs (PC1+PC2+...) improves R2 for all outcomes
 - sequentially adding genetic PCs (PC1+PC2+...) strengthens associations between genetic cateogry and iAUC metabolites as shown in the bottom panel for glucose and insulin - **associations strengthen and then plateau when adding the top 3 PCs**
 
 
 
 


