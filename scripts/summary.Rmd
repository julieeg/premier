---
title: "PREMIER Summary: Figures & Tables for Submitted Manuscript"
output: html_document
theme: united
date: "2025-01-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, fig.width = 10, fig.height = 5)

#Load libraries
library(Hmisc)
library(tidyverse)
library(data.table)
library(devtools)
library(ggpubr)
library(knitr)
library(ggrepel)
library(ggtext) # element_markdown (for italics)
library(table1)

# Load pantry "package"
lapply(list.files("../../pantry/functions/", recursive = T, full.names = T), source)

# Load data files
analysis <- readRDS("../data/processed/premier_analysis.rda") %>%
  mutate(genotype = relevel(genotype, ref="HC genotype"))

# Load metabolite information file
met_info <- fread("../data/processed/met_info_processed.csv")
metab_dict <- fread("../data/processed/met_dictionary.csv")

# Set plot parameters
premier_palettes <- c(
  oranges = c("#FAD7B8", "#F6AA65", "#E55C1D", "#B34901", "#731F04","#411003"),
  blues = c("#C7E4FA", "#87C2EE", "#4091DA", "#1360A9", "#0B3771", "#011C47")
  )

parameters <- list(
  total = list(label="Total cohort", palette=palettes$NatMainBackground2x2[1]),
  genotype = list(label = "Genotype", 
                  strata = "genotype", 
                  #palette = palettes$NatMainAccent3$Level3[1:2]) 
                  palette = c("HF genotype"="#1360A9", "HC genotype"="#B34901"),
                  levels=c("HC genotype", "HF genotype"), levels_fancy=c("HC\ngenotype", "HF\ngenotype")),
  meal_choice = list(label = "Meal type", strata="meal_choice", 
                     #palette = palettes$NatMainAccent3$Level5[1:2],
                     palette = c("HC meal"="#731F04", "HF meal"="#0B3771"),
                     levels=c("HC meal", "HF meal"), levels_fancy=c("HC\nmeal", "HF\nmeal")), 
  gene_x_meal = list(label = "Genotype x Meal type", 
                     strata="genetic_cat_x_meal_choice", 
                     #palette = c(palettes$NatMainAccent3$Level3[1:2], palettes$NatMainAccent3$Level5[1:2])[c(1,3,4,2)],
                     palette = c("HC genotype x HC meal" = "#E96900", "HC genotype x HF meal" = "#F29741",
                                 "HF genotype x HC meal" = "#5496CE", "HF genotype x HF meal" = "#006EAE"),
                     levels=c("HC genotype\nx HC meal", "HC genotype\nx HF meal", "HF gneotype\nx HC meal", "HF genotype\nx HF meal"),
                     levels_fancy=c("HC genotype\nx HC meal", "HC genotype\nx HF meal", "HF gneotype\nx HC meal", "HF genotype\nx HF meal"))
  )

genotypes <- c("HC genotype", "HF genotype")
meals <- c("HC meal", "HF meal")

ggplot_ms <- theme_classic() + theme(
  #panel.grid = element_line(linewidth=0.25),
  panel.grid = element_line(linewidth=0.25, color="#00000020"),
  panel.grid.minor = element_blank(),
  axis.line = element_line(linewidth=0.25),
  legend.background = element_rect(linewidth = 0.15, color="white", fill="white"),
  #legend.margin = margin(0.25,0.25,0.25,0.25,unit="pt"),
  #legend.margin = margin(rep(0.15,4), unit="cm"),
  legend.margin = margin(0.25,0.75,0.25,0.75,unit="mm"),
  legend.direction = "horizontal", 
  legend.position = c(0.5,-0.5), 
  legend.title = element_blank(), #element_text(face="bold"),
  legend.text = element_text(size=11),
  legend.key = element_rect(fill=NA, color=NA),
  axis.text = element_text(color="black")
) 

unit="mgdL" ; Unit="mg/dL"

metab_dict <- fread("../data/processed/met_dictionary.csv")
metabolites_pp <- fread("../data/processed/metbolites_pp.txt")$metabolites_pp # 547 changing postprandially (p<0.05)
metab_suppl_info <- fread("../output/tab_res_mmtt_metab_ppwithdescr.csv")

```


##### Plotting Functions 
```{r}
# ================================================================
## Spaghetti plot of postprandial responses 
# ================================================================

## Stratified; individual-level + summary --------------------------
plot_ppXtime_stratified <- function(metabolite, times = c(0,30,60,120,180,235), 
                                       strata="genotype", data=analysis, p_value=F) {
  strata_var=parameters[[strata]]$strata 
  y_label=paste0("Plasma ", metabolite, " (", Unit, ")")
  dat <- data %>% select(id, starts_with(metabolite), strata=all_of(strata_var)) %>%
    rename_with(~gsub(metabolite, "x", .), starts_with(metabolite)) %>%
    rename_with(., ~gsub("m", "", gsub("_log", "", .))) %>%
    select(id, strata, paste0("x_", times)) %>%
    pivot_longer(-c(id, strata), names_sep="_", names_to=c("metabolite", "time")) %>%
    mutate(across(c("time", "value"), ~as.numeric(.))) %>%
    group_by(strata, time) %>% 
    filter(is.na(strata)==F) #%>%
    
  dat.summary <- dat %>% 
    reframe(n=n(), mean=mean(value, na.rm=T), sd=sd(value, na.rm=T)) %>%
    mutate(se=sd/sqrt(n)) %>% filter(!is.na(strata))
  
  dat %>% 
    ggplot(aes(x=time, y=value, group=id, color=strata)) + 
    scale_x_continuous(breaks=times) +
    geom_line(alpha=0.45, linewidth=0.25) + 
    stat_summary(aes(group = strata), geom = "point", fun = mean, size = 2, , alpha=0.85, position=position_dodge(5.5)) + 
    stat_summary(aes(group = strata), geom = "line", fun = mean, linewidth = 1, alpha=0.85, position=position_dodge(5.5)) +
    geom_errorbar(data=dat.summary, aes(x=time, y=mean, ymin=mean-se, ymax=mean+se, 
                      color=strata, group=strata), inherit.aes = F, position=position_dodge(5.5),
                  width=10, linewidth=0.75, alpha=0.85) +
    scale_color_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    scale_y_continuous(expand=c(0.1,0.05)) +
    xlab("Time (minutes)") + ylab(y_label) + 
    #theme_classic() + 
    #theme(panel.grid.major = element_line(linewidth=0.2))
    ggplot_ms 
}

# ==================================================
## Plot mean iAUC - stratified 
# ==================================================

plot_iAUC_strat <- function(metabolite, y_extend=c(0.15,0), iAUC=120, strata, fancy_x=T, data=analysis) {
  strata_var=parameters[[strata]]$strata 
  y_label = paste("120 min iAUC", metabolite, "\n(mg·min/dL)")
  
  p <- data %>% select(id, starts_with(metabolite) & ends_with(paste0(iAUC,"iAUC.pos")), strata=all_of(strata_var)) %>%
    rename_at(paste0(metabolite, "_", iAUC, "iAUC", ".pos"), ~gsub(paste0("[_]", iAUC,"iAUC.*"), "", gsub(metabolite, "value", .))) %>%
    group_by(strata) %>% filter(complete.cases(strata)) %>%
    reframe(n=n(), mean=mean(value), sd=sd(value)) %>% mutate(se=sd/sqrt(n)) %>%
    
    ggplot(aes(x=strata, y=mean, ymin=mean-se, ymax=mean+se, fill=strata)) + 
    geom_bar(stat="identity", alpha=0.99) + geom_errorbar(width=0.075) +
    xlab(parameters[[strata]]$label) + ylab(y_label) + 
    scale_fill_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    #theme_bw() + 
    #theme(axis.text.x = element_blank()) 
    ggplot_ms
  
    p <- ggplot_extend_ylim(p, y_max_extend=y_extend[1], y_extend[2])
    
    if(fancy_x == T) {
      p <- p + #xlab("") + #theme(axis.text.x = element_text(vjust=-0.5, color="black", size=11)) + 
        scale_x_discrete(labels = gsub("\ngenotype", "", parameters[[strata]]$levels_fancy)) +
        theme(axis.title.x = element_text(color="black", size=11))
      } ; p
}

plot_iAUC_strat_panel <- function(metabolite, iAUC=360, y_extend=c(0.15,0), 
                            strata="genotype", panel="meal_choice", fancy_x=T, data=analysis) {
  strata_var=parameters[[strata]]$strata 
  y_label = paste("120 min iAUC", metabolite, "\n(mg·min/dL)")
  p <- data %>% select(id, starts_with(metabolite) & ends_with(paste0(iAUC,"iAUC.pos")), strata=all_of(strata_var), panel=all_of(panel)) %>%
    rename_at(paste0(metabolite, "_", iAUC, "iAUC.pos"), ~gsub(paste0("[_]", iAUC,"iAUC.pos"), "", gsub(metabolite, "value", .))) %>%
    group_by(strata, panel) %>% filter(complete.cases(strata)) %>%
    reframe(n=n(), mean=mean(value), sd=sd(value)) %>% mutate(se=sd/sqrt(n)) %>%
    mutate_at("panel", ~factor(., levels=c("HC meal", "HF meal"))) %>%
    mutate_at("strata", ~factor(., levels=genotypes)) %>%
    mutate(col = paste(strata, "x", panel)) %>% 
    
    ggplot(aes(x=strata, y=mean, ymin=mean-se, ymax=mean+se, fill=col)) +
    facet_grid(cols=vars(panel)) +
    geom_bar(stat="identity", alpha=0.99) + geom_errorbar(width=0.075) +
    xlab(parameters$gene_x_meal$label) + ylab(y_label) + 
    scale_fill_manual(values=parameters$gene_x_meal$palette, name=parameters$gene_x_meal$label) + 
    #theme_bw() + theme(axis.text.x = element_blank()) + 
    ggplot_ms + 
    theme(strip.background = element_blank(), strip.text=element_text(face="bold", size=14))
    
    p <- ggplot_extend_ylim(p, y_max_extend=y_extend[1], y_extend[2])
    if(fancy_x == T) {
      p <- p + xlab("") + theme(axis.text.x = element_text(vjust=-0.5, color="black", size=11)) + 
        scale_x_discrete(labels = parameters[[strata]]$levels_fancy)
      } ; p
}

plot_iAUC_strat2 <- function(metabolite, y_extend=c(0.15,0), iAUC=360, data=analysis) {
  y_label = paste("120 min iAUC", metabolite, "\n(mg·min/dL)")
  p <- data %>% select(id, starts_with(metabolite) & ends_with(paste0(iAUC,"iAUC.pos")), genotype, meal_choice) %>%
    rename_at(paste0(metabolite, "_", iAUC, "iAUC", ".pos"), ~gsub(paste0("[_]", iAUC,"iAUC.*"), "", gsub(metabolite, "value", .))) %>%
    group_by(genotype, meal_choice) %>% filter(complete.cases(genotype) & complete.cases(meal_choice)) %>%
    reframe(n=n(), mean=mean(value), sd=sd(value)) %>% mutate(se=sd/sqrt(n)) %>%
    mutate(col = paste(genotype, "x", meal_choice)) %>%
    ggplot(aes(x=meal_choice, y=mean, ymin=mean-se, ymax=mean+se, fill=col, group=genotype)) + 
    geom_bar(stat="identity", alpha=0.99, position=position_dodge(0.9), width=0.8) + 
    geom_errorbar(width=0.075, position=position_dodge(0.9)) +
    xlab(parameters$gene_x_meal$label) + ylab(y_label) + 
    scale_fill_manual(values=parameters$gene_x_meal$palette, name=parameters$gene_x_meal$label) + 
    scale_x_discrete(expand = c(0.5,0)) +
    #theme_bw() + 
    ggplot_ms +
    theme(
      axis.title.x = element_blank(), axis.text.x = element_text(face="bold", size=12)) 
    p <- ggplot_extend_ylim(p, y_max_extend=y_extend[1], y_extend[2])
    p
}
```


## *Mixed-Meal Tolerance Tests*
### Fig 2a,b. Effect of genotype on postprandial resopnses over 4h (a) & 120 min iAUC glucose/insulin
```{r}
## a) postprandial resposnes by genotype (height=3.5,width=8; error_bar width=10 ??)
p_glu_geno_indiv <- plot_ppXtime_stratified("glucose", times = c(0,30,60,120,180,235)) +
  coord_cartesian(ylim=c(45,165)) + scale_y_continuous(breaks=seq(30,150,30)) + 
  annotate("text", x = 60.25, y = 140, label = "**", size = 5.25) +
  geom_segment(aes(x = 53, xend = 67, y = 139, yend = 139), linewidth = 0.2, color="black") +
  guides(color = guide_legend(override.aes = list(linetype = 1, size = 1.2)))

p_insu_geno_indiv <- plot_ppXtime_stratified("insulin", times = c(0,30,60,120,180,235)) + 
  coord_cartesian(ylim=c(-5,135)) + scale_y_continuous(breaks=seq(0,125,30)) + 
  annotate("text", x = 60.25, y = 78, label = "**", size = 5.25) +
  geom_segment(aes(x = 53, xend = 67, y = 77, yend = 77), linewidth = 0.2, color="black") 
fig2a <- ggarrange("", p_glu_geno_indiv, "", p_insu_geno_indiv, common.legend = T, 
                   legend = "top", nrow=1, widths=c(0.05,1,0.05,1), align="hv") ; fig2a 

## b) iAUC (pos) by genotype
p_glu_geno_iauc <- plot_iAUC_strat("glucose", strata="genotype", fancy_x = T) +
  coord_cartesian(ylim=c(0,3000)) + scale_y_continuous(breaks=seq(0,3000,1000)) + 
  geom_segment(aes(x = 0.9, xend = 2.1, y = 2500, yend = 2500), linewidth = 0.35) + 
  annotate("text", x = 1.5, y = 2550, label = "**", size = 6) 
p_insu_geno_iauc <- plot_iAUC_strat("insulin", strata="genotype", fancy_x = T) +
  coord_cartesian(ylim=c(0,3000)) + scale_y_continuous(breaks=seq(0,3000,1000)) #+
  #theme(axis.text.x = element_text(size=11))
fig2b <- ggarrange("", p_glu_geno_iauc, "", p_insu_geno_iauc, "", common.legend = T, 
                   legend = "none", nrow=1, widths=c(0.05,1,0.05,1,0), align="hv") ; fig2b

## P-values added to plot?
summary(lm(glucose_120iAUC.pos ~ genotype+age+sex+PC1z+PC2z+PC3z, data = analysis)) # Ppair = 0.00666 ; Panova=0.085
summary(lm(insulin_120iAUC.pos ~ genotype+age+sex+PC1z+PC2z+PC3z, data = analysis)) # Ppair = 0.225 ; Panova=0.335

fig2ab <- ggarrange(fig2a,"", fig2b, ncol=1, align="h", heights=c(1.15, 0.15,1)) ; fig2ab

# Save plot as PDF
fig2ab %>% ggsave(filename="../output/fig2ab_mmtt_v3.pdf", width=6.5, height=6)

```



## Triglyceride
```{r}
## a) postprandial TG by genotype (height=3.5,width=8; error_bar width=10 ??)
analysis$tg_0=analysis$tg
p_tg_geno_indiv <- plot_ppXtime_stratified("tg", times = c(0,120,235),
                                           data = analysis %>% select(-starts_with("tg_log")) %>% filter(id != "P28")) +
  #coord_cartesian(ylim=c(45,165)) + scale_y_continuous(breaks=seq(30,150,30)) + 
  guides(color = guide_legend(override.aes = list(linetype = 1, size = 1.2)))
```

### Fig 2g, Meal selection by genotype 
```{r, echo=F, warning=F, fig.width=6, fig.height=2}
fig2g <- analysis %>% group_by(genotype) %>%
  filter(complete.cases(genotype, meal_choice)) %>%
  dplyr::count(genotype, meal_choice) %>%
  mutate(genotype = relevel(genotype, ref="HC genotype")) %>%
  mutate(geneXmeal = paste0(genotype, " x ", meal_choice)) %>%
  mutate(pct = ifelse(genotype=="HC genotype", n/12, n/10)*100) %>%
  mutate_at("geneXmeal", ~factor(., levels=c("HC genotype x HF meal", "HC genotype x HC meal", 
                                             "HF genotype x HF meal","HF genotype x HC meal"))) %>%
  ggplot(aes(x=genotype, y=pct, fill=geneXmeal)) +
  geom_bar(stat="identity", position=position_stack()) +
  scale_fill_manual(values=parameters$gene_x_meal$palette, name="Genotype x Meal choice") + 
  scale_x_discrete(labels = gsub("\ngenotype", "", parameters$genotype$levels_fancy)) +
  ggplot_ms + 
  theme(axis.text.x=element_text(color = "black", size=11, vjust=-0.5),
        axis.text.y = element_text(size=12), axis.title.y = element_text(color = "black", size=12),
        legend.key.size = unit(0.45, "cm"),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.direction = "vertical",
        legend.position = "bottom",
        panel.border = element_rect(color="black", fill = "#FFFFFF00")) +
  ylab("Percent, per meal type") + xlab("Genotype") + 
  guides(fill = guide_legend(reverse = F)) + 
  theme(axis.title.x = element_text(color="black", size=11, vjust=-0.5)); fig2g

fig2g_formatted <- ggarrange("", fig2g, widths=c(0.05,1))

fig2g_formatted %>% ggsave(filename="../output/fig2g_mealxgeno_v3.pdf", height=6.5, width=2.5)

fig2legend <- fig2g + theme(legend.direction = "horizontal",
              legend.text = element_text(size=10),
              legend.title = element_text(size=11)) 
fig2legend %>% ggsave(filename="../output/fig2_legend.pdf", height=5.5, width=10.5)
```


## *Self-Selected Meal Tolerance Tests*
### Fig h,i Postprandial glucose & insulin, by genetic category & meal selection
```{r, echo=F, fig.height=8, fig.width=12}
meals <- c("HC meal", "HF meal")

## a) postprandial resposnes by genotype (height=3.5,width=8)
p_ssmt.l <- lapply(c("glucose", "insulin"), function(y) { 
  lapply(meals, function(m) {
    p <- plot_ppXtime_stratified(y, times = c(235,270,300,360), strata = "gene_x_meal", 
                            data=analysis %>% filter(meal_choice==m)) + 
      theme(axis.text.y=element_text(size=12)) + coord_cartesian(ylim=y_lim) 
    if(y=="glucose") {
      p <- p + ggtitle(m) + theme(plot.title = element_text(hjust=0.5, face="bold", size=12),
                                  axis.text.x = element_blank(), axis.ticks.x = element_blank(),
                                  axis.title.x =  element_blank(), axis.title.y = element_text(size=12)) + 
        coord_cartesian(ylim=c(50,150)) + scale_y_continuous(limits = c(50,150), breaks = seq(50,150,25))
      } ; if(y == "insulin") {
        p <- p + theme(axis.title.y = element_text(vjust=2.5, size=12)) + 
          coord_cartesian(ylim=c(0,60)) + scale_y_continuous(limits = c(0,60), breaks = seq(0,60,15))
      } ; p })
  })

## Fig 2h
p_ssmt_glu_indiv <- ggarrange(
  plotlist=c("", p_ssmt.l[[1]][1], "", p_ssmt.l[[1]][2]), 
  nrow=1, widths=c(0.05,1,0.05,1), common.legend = T, legend = "none") ; p_ssmt_glu_indiv
p_ssmt_insu_indiv <- ggarrange(
  plotlist=c("", p_ssmt.l[[2]][1], "", p_ssmt.l[[2]][2]), 
  nrow=1, widths=c(0.065,1,0.065,1), common.legend = T, legend = "none") ; p_ssmt_insu_indiv

fig2h <- ggarrange(p_ssmt_glu_indiv, "", p_ssmt_insu_indiv, legend = "none", 
                   nrow=3, heights=c(1.05,0.025,1.0), align="hv") ; fig2h 

fig2h %>% ggsave(filename="../output/fig2h_ssmt_v3.pdf", width=7, height=5)

## Fig 2i - v1
fig2i <- ggarrange("", plot_iAUC_strat_panel("glucose", fancy_x = F) + 
                     ylab("120 min iAUC glucose\n(mg·min/dL)") +
                     theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
                           axis.ticks.x = element_blank(), strip.text = element_text(size=12),
                           axis.text.y = element_text(size=12), axis.title.y = element_text(size=12),
                           plot.margin = margin(0,0.1,0,0.1, unit="cm")),"",
                   plot_iAUC_strat_panel("insulin") + 
                     ylab("120 min iAUC glucose\n(mg·min/dL)") +
                     theme(strip.text = element_blank(), axis.text.x = element_text(size=12),
                           axis.text.y = element_text(size=12), axis.title.y = element_text(size=12),
                           plot.margin = margin(0,0.1,0,0.1, unit="cm")), 
                   common.legend = T, legend = "none", nrow=4, heights=c(0.05,1,0.1,1.1)) ; fig2i 

fig2i %>% ggsave(filename="../output/fig2i_ssmt_iauc.pdf", width=4.5, height=5.5)


# ===============
## Fig 2i - v2
# ===============

fig2i <- ggarrange("", plot_iAUC_strat2("glucose") + 
                     theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
                           axis.ticks.x = element_blank(), strip.text = element_text(size=12),
                           axis.text.y = element_text(size=12), axis.title.y = element_text(size=12),
                           #plot.margin = margin(0,0.1,0,0.1, unit="cm")
                           ) + 
                     # P=0.042 for glu ~ genotype for HF diet
                     geom_segment(aes(x = 1.7, xend = 2.3, y = 2200, yend = 2200), linewidth = 0.25) + 
                     annotate("text", x = 2, y = 2220, label = "*", size = 6) + 
                     # P=0.00386 for glu ~ meal for HC geno
                     geom_segment(aes(x = 0.75, xend = 1.8, y = 2050, yend = 2050), linewidth = 0.25) + 
                     annotate("text", x = 1.25, y = 2070, label = "**", size = 6),"",
                   plot_iAUC_strat2("insulin") + 
                     ylab("120 min iAUC insulin\n(mg·min/dL)") +
                     theme(strip.text = element_blank(), axis.text.x = element_text(size=12, vjust=-0.35),
                           axis.text.y = element_text(size=12), axis.title.y = element_text(size=12)),
                   common.legend = T, legend = "none", nrow=4, heights=c(0.05,1,0.05,1.05)) ; fig2i 

fig2i %>% ggsave(filename="../output/fig2i_ssmt_iauc_v2.pdf", width=3.75, height=5)

```



## Metabolomics 

Basic plotting functions for metabolomics data
```{r}
# ================================================================
## Volcano plots for metabolomics: for log-transformed betas
# ================================================================
plot_volcano.fun <- function(data, p_threshold=0.05/30, beta_threshold=0.5, title="", add_labels=T, bolded_labels=F, 
                             col1, col2, colUnq=col2, p_label="0.05/30") {
  
  p <- data %>% 
    mutate(across(c(beta, se, p), ~as.numeric(.))) %>%
    mutate(col = ifelse(p<p_threshold & abs(beta) > beta_threshold, "A", 
                                 ifelse(p>=p_threshold & abs(beta) > beta_threshold, "B", "C"))) %>%
    #Add column to bold unique metabolites
    mutate(add_bold = ifelse(is.na(bolded_labels[1]) == F & outcome %in% bolded_labels, "bold", "plain")) %>%
    ggplot(aes(x=beta, y=-log10(p), color=col)) +  
    facet_grid(~Time) +
    geom_point(size=2, alpha=0.85) + 
    scale_color_manual(values=c("A"=col1, "B"=col2, "C"="lightgrey"), 
                       labels=c(A=paste0("P <", p_label, " & log2 fold change >",beta_threshold),
                                B=paste0("log2 fold change >",beta_threshold), 
                                C=paste0("P>",p_label, " & log2 fold change <", beta_threshold)), name="") + 
    theme_bw() + xlab("Beta coefficient for HC vs HF (ref) genotype \n of log2 fold change from 0 min") +
    geom_hline(yintercept = -log10(p_threshold), linetype="dashed") + 
    geom_vline(xintercept = c(-beta_threshold, beta_threshold), linetype="dashed") + 
    ggtitle(title) + 
    ggplot_ms + 
    theme(legend.key.size = unit(0.5, "cm")) + 
    theme(strip.background = element_blank(),
          legend.title = element_blank(),
          strip.text = element_text(face="bold"),
          axis.title.x = element_text(size=8),
          panel.grid.minor.x = element_line(linewidth=0.25),
          panel.border = element_rect(colour = "black", fill=NA)
          )
  
  # Add labels
  if(add_labels==T) {
    p <- p + geom_label_repel(aes(label=Lab, fontface = ifelse(add_bold == "bold", "bold", "plain")), 
                              label.padding = 0.05, box.padding = 0.05, nudge_y = 0.1,
                              size=3, color="black", fill=NA, label.size = 0, max.overlaps = 20) ## WAS
  } ; p
}

```


Summary of metabolite changes by time: postprandial metabolites
```{r}
# ========================================================
## Descriptive table of ALL labeled metabolites available for analysis
# ========================================================

met_info %>% 
  select(Method, Compound, MZ, RT, Metabolite=Name, HMDB) %>%
  fwrite("../output/Tab_allMetabolites_print.csv")

tab_res_mmtt_metab_timeonly <- fread("../data/processed/tab_prelim_lme_metab_mmtt_timeonly.csv") 

res_mmtt_metab_timeonly <- tab_res_mmtt_metab_timeonly %>% 
  mutate(fc=exp(beta), log2fc=beta/log(2)) %>%
  filter(Exposure != "Time_(joint)") %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub("Time_", "", .), " min")) 

## Summary of significant metabolites
tab_descr_metab_postprand_pEff <- res_mmtt_metab_timeonly %>% 
  filter(p<0.05/30) %>% pull(outcome) %>% unique() 

length(tab_descr_metab_postprand_pEff) # N=429 metabolites changing significantly, based on correction for effective tests P <0.05/30
tab_descr_metab_postprand_pEff %>% 
  as.data.frame() %>% fwrite("../data/processed/tab_dat_mmtt_metab_postprandial.txt")


## Save descriptive info for significant metabolites
descr_metab_pp <- met_info %>% 
  select(Method, Compound, MZ, RT, Metabolite=Name, HMDB) %>% 
  #filter(HMDB %in% tab_descr_metab_postprand_pEff) %>%
  left_join(metab_dict %>% select(HMDB=HMDB_ID, Super.class, Main.class, Sub.class))

# Merge in postprandial effect estimate, for Supplementary Table
descr_metab_pp <- descr_metab_pp %>% left_join(
  tab_res_mmtt_metab_timeonly %>% select(HMDB=outcome, Exposure, P, Beta.SE) %>%
    filter(Exposure != "Time_(joint)") %>%
    mutate_at("Exposure", ~gsub("Time_", "", .)) %>%
    pivot_wider(names_from="Exposure", values_from=c("Beta.SE", "P")),
  by="HMDB")  %>% 
  mutate(P_postprandial = ifelse(P_120<0.05 | P_235 <0.05,1,0)) %>%
  mutate(P_signif = ifelse(P_120<0.05/30 | P_235 <0.05/30,1,0)) %>%
  arrange(desc(-log(P_120)))

#descr_metab_pp %>% fwrite("../output/Tab_descr_metabs_postprandial.csv")

## Tabulate sub-classes for all and significant metabolites
subs <- unique(descr_metab_pp$Sub.class) ; sub_classes <- subs[complete.cases(subs)]
mains <- unique(descr_metab_pp$Main.class) ; main_classes <- mains[complete.cases(mains)]
supers <- unique(descr_metab_pp$Super.class) ; super_classes <- supers[complete.cases(supers)]
tab_metab_subs <- lapply(unique(sub_classes), function(i) {
  metabs <- descr_metab_pp %>% filter(Sub.class == i) 
  n <- nrow(metabs) 
  metabs_formatted <- paste0(metabs %>% pull(Metabolite), collapse=", ")
  classes <- metabs %>% select(Super.class, Main.class) %>% unique()
  cbind.data.frame(classes, Sub.class=i, N=n, Metabolites=metabs_formatted) 
  }) %>% do.call(rbind.data.frame, .) ; tab_metab_mains <- lapply(main_classes, function(i) {
  metabs <- tab_metab_subs %>% filter(Main.class == i) 
  n <- sum(metabs$N) 
  cbind.data.frame(N.mains = n, metabs)
}) %>% do.call(rbind.data.frame, .) ; tab_metab_supers <- lapply(super_classes, function(i) {
  metabs <- tab_metab_mains %>% filter(Super.class == i) 
  n <- sum(metabs$N)
  cbind.data.frame(N.supers = n, metabs)
}) %>% do.call(rbind.data.frame, .) ; tab_metab_supers %>%
  select(Super.class, N.supers, Main.class, N.mains, Sub.class, N, Metabolites) 
tab_metab_subs %>% arrange(Super.class, Main.class, N) %>% fwrite("../output/Tab_res_mmtt_metabolites_v2.csv")

## Metabolites WITHOUT matched classes
paste0(descr_metab_pp %>% filter(is.na(Main.class)) %>% pull(Metabolite), collapse = ", ") %>%
  as.data.frame() %>%
  fwrite("../output/Tab_descr_metabs_noclass.txt")

```


### Summary of metabolites changing by time, STRATIFIED by genotype
```{r}
# Time effect, among all participants (i.e., postprandial metabolites)
tab_res_mmtt_metab_timeonly <- fread("../data/processed/tab_prelim_lme_metab_mmtt_timeonly.csv")
res_mmtt_metab_timeonly <- tab_res_mmtt_metab_timeonly %>% 
  mutate(beta=beta/log(2)) %>%
  filter(Exposure != "Time_(joint)") %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub("Time_", "", .), " min")) %>%
  mutate_at("Time", ~factor(., levels=c("120 min", "235 min")))

# Time effect, stratified by genotype (i.e., genotype-specific postprandial metabolites)
tab_res_mmtt_metab_time_bygeno <- fread("../output/tab_res_mmtt_metab_timeEffect_byGeno.csv")
res_mmtt_metab_time_bygeno <- tab_res_mmtt_metab_time_bygeno %>% 
  mutate(beta=beta/log(2)) %>%
  filter(Exposure != "Time_(joint)") %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub("Time_", "", .), " min")) %>%
  mutate_at("Time", ~factor(., levels=c("120 min", "235 min")))


## Metabolite Lists
metabs.hc120 <- fread("../data/processed/pathways/hc120_pEff_log2fc05.txt", col.names = "V1") %>% pull(V1) ; length(metabs.hc120) #163
metabs.hc235 <- fread("../data/processed/pathways/hc235_pEff_log2fc05.txt", col.names = "V1") %>% pull(V1) ; length(metabs.hc235) #187
metabs.hf120 <- fread("../data/processed/pathways/hf120_pEff_log2fc05.txt", col.names = "V1") %>% pull(V1) ; length(metabs.hf120) #159
metabs.hf235 <- fread("../data/processed/pathways/hf235_pEff_log2fc05.txt", col.names = "V1") %>% pull(V1) ; length(metabs.hf235) #151


## Counting UNIQUE metabolites in each group
metabs.hc120.unq <- metabs.hc120[!metabs.hc120 %in% metabs.hf120] ; length(metabs.hc120.unq) # 26 unique metabolites for HC/120
metabs.hf120.unq <- metabs.hf120[!metabs.hf120 %in% metabs.hc120] ; length(metabs.hf120.unq) # 22 unique metabolites for HC/120
metabs.hc235.unq <- metabs.hc235[!metabs.hc235 %in% metabs.hf235] ; length(metabs.hc235.unq) # 57 unique metabolites for HC/120
metabs.hf235.unq <- metabs.hf235[!metabs.hf235 %in% metabs.hc235] ; length(metabs.hf235.unq) # 21 unique metabolites for HC/120


## Listing time-specific metabolites for both genotypes (i.e, intersection at each time point)
metabs.all120 <- (res_mmtt_metab_timeonly %>% filter(outcome %in% c(intersect(metabs.hc120, metabs.hf120))) %>%
  arrange(p) %>% pull(outcome))[1:20] 
metabs.all235 <- (res_mmtt_metab_timeonly %>% filter(outcome %in% c(intersect(metabs.hc235, metabs.hf235))) %>%
  arrange(p) %>% pull(Outcome))


## Metabolite Labels - SORT by STRENGTH (top 20 unique metabolits for each genotype/time)
metabs.hc120.unq.top20 <- metabs.hc120.unq[1:20] ; metabs.hc235.unq.top20 <- metabs.hc235.unq[1:20]
metabs.hf120.unq.top20 <- metabs.hf120.unq[1:20] ; metabs.hf235.unq.top20 <- metabs.hf235.unq[1:20]


## Gather bile acids
bile_acids <- fread("../data/processed/tab_descr_bileacids_mmtt.csv")

bileacids.hc <- bile_acids %>% filter(HC120_only==1 | HC235_only == 1) %>% pull(Abbrev)
names(bileacids.hc) <- bile_acids %>% filter(HC120_only==1 | HC235_only == 1) %>% pull(HMDB)

bileacids.all <- bile_acids %>% pull(Abbrev)
names(bileacids.all) <- bile_acids %>% pull(HMDB)

```



## Volcano plots by genotype
```{r}
# ========================================================
# Volcano plots for metabolite changes over time 
# ========================================================

# All participants **for timeonly, the beta coefficients have NOT yet been transformed to log(2)**
p_v.all <- plot_volcano.fun(
  res_mmtt_metab_timeonly %>% mutate(beta=beta/log(2)) %>%
    mutate(Lab = ifelse(Time == "120 min" & outcome %in% metabs.all120, gsub(" &.*", "", Outcome), 
                        ifelse(Time == "235 min" & outcome %in% metabs.all235, gsub(" &.*", "", Outcome), NA))),
  add_labels = T, col1="#00000098", col2="#7F7F7F95", beta_threshold = 0.5) +
  facet_grid(cols=vars(Time)) + 
  #theme(panel.grid = element_line(color="lightgray", linewidth = 0.55)) + 
  xlab("Beta coefficient for the log2 fold change at \n 120 or 235 min from 0 min") +
  coord_cartesian(ylim=c(0,25), xlim=c(-8,10)) ; p_v.all

p_v.all #%>% ggsave(filename="../output/fig_Sx_mmtt_metab_all.pdf", width=8, height=4)
  

# HC genotype
p_v.hc <- plot_volcano.fun(
  res_mmtt_metab_time_bygeno %>% 
    mutate_at("Outcome", ~gsub(" or.*", "", .)) %>%
    mutate(Outcome = ifelse(outcome %in% names(bileacids.hc), bileacids.hc[outcome], Outcome)) %>% 
    mutate(Lab = ifelse(Time == "120 min" & outcome %in% metabs.hc120.unq.top20, Outcome, 
                          ifelse(Time == "235 min" & outcome %in% metabs.hc235.unq.top20, Outcome, NA))) %>% 
    filter(genotype=="HC genotype"), add_labels = T, bolded_labels = names(bileacids.all),
  col1=parameters$genotype$palette[[2]], col2="#D39373", 
  beta_threshold = 0.5, p_threshold = 0.05/30) +
  facet_grid(cols=vars(Time)) + 
  theme(plot.margin = margin(c(0,0,-0.1,0), unit="line"),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.y = element_text(size=12), axis.text.y = element_text(size=11),
        strip.text = element_text(face="bold", size=12)) + 
  #geom_text(data = data.frame(label="HC genotype (N = 12)", x=-8.35, y=12.35), 
   #         aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
  coord_cartesian(ylim=c(0,13), xlim=c(-8,8)) + 
  scale_y_continuous(breaks=seq(0,15,4)) + scale_x_continuous(breaks=seq(-8,10,4)); p_v.hc


# HF genotype
p_v.hf <- plot_volcano.fun(
  res_mmtt_metab_time_bygeno %>% mutate(beta=beta/log(2)) %>% 
    mutate_at("Outcome", ~gsub(" or.*", "", .)) %>%
    mutate(Lab = ifelse(Time == "120 min" & outcome %in% metabs.hf120.unq.top20, Outcome,
                        ifelse(Time == "235 min" & outcome %in% metabs.hf235.unq.top20, Outcome, NA))) %>% 
    filter(genotype=="HF genotype"), 
  col1=parameters$genotype$palette[[1]], col2="#81A0C8", beta_threshold = 0.5, add_labels = T) +
  facet_grid(cols=vars(Time)) + 
  xlab("Beta coefficient for log<sub>2</sub> fold change from 0 min") + 
  theme(plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_markdown(size=12), axis.text.x = element_text(size=11),
        axis.title.y = element_text(size=12), axis.text.y = element_text(size=11),
        strip.text = element_blank()) +
  #geom_text(data = data.frame(label="HF genotype (N = 10)", x=-8.35, y=12.35), 
   #         aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
  coord_cartesian(ylim=c(0,13), xlim=c(-8,8)) +
  scale_y_continuous(breaks=seq(0,15,4)) + scale_x_continuous(breaks=seq(-8,10,4)); p_v.hf

## Vertical-v2, excluding total plot
fig2c <- ggarrange(ggarrange(p_v.hc, p_v.hf, ncol=1, common.legend = F, legend = "none"))
fig2c %>% ggsave(filename="../output/fig2c_mmtt_metab_v3.pdf", width=6, height=5.5)

```

## Enrichment plots & genotype-specific metabolites 
```{r}
# ====================================================================
## Descriptive pathway enrichment plots 
# ====================================================================

# P <0.05/23 && B >0.05 -------------------
metab_sets <- rbind.data.frame(
  #fread("../data/metaboanalyst/oea/oea_peff_b05/oea_hc120/msea_ora_result.csv") %>% mutate(set="HC genotype @ 120 min"),
  fread("../data/metaboanalyst/hc120/msea_ora_result.csv") %>% mutate(set="HC genotype @ 120 min"),
  fread("../data/metaboanalyst/hc235/msea_ora_result.csv") %>% mutate(set="HC genotype @ 235 min"),
  fread("../data/metaboanalyst/hf120/msea_ora_result.csv") %>% mutate(set="HF genotype @ 120 min"),
  fread("../data/metaboanalyst/hf235/msea_ora_result.csv") %>% mutate(set="HF genotype @ 235 min")
  ) %>% rename(p="Raw p") %>%
  mutate(log10p=-log10(p)) %>%
  mutate(Metabolite.Set = factor(V1, levels = rev(unique(V1[order(p)])))) %>%
  mutate(genotype = gsub("[@].*", "", set),
        time = gsub(".*[@] ", "", set)
        ) ; metab_sets

## Filter for only the top ~15 pathways
to_plot <- c("Biosynthesis of unsaturated fatty acids", "Primary bile acid biosynthesis",
             "Pyrimidine metabolism", "Pantothenate and CoA biosynthesis",
             "beta-Alanine metabolism", "Caffeine metabolism", 
             "Linoleic acid metabolism", "Alanine, aspartate and glutamate metabolism", 
             "Thiamine metabolism", "Fatty acid biosynthesis")

fig2d <- metab_sets %>% 
  select(V1, log10p, Metabolite.Set, genotype, time) %>%
  filter(V1 %in% to_plot) %>%
  mutate_at("Metabolite.Set", ~factor(., levels=rev(Metabolite.Set[c(1:4,9,5:8,10)]))) %>%
  ggplot(aes(x=log10p, y=Metabolite.Set, fill = genotype, group = genotype)) + 
  facet_grid(~time) + 
  theme_bw() + ggplot_ms + 
  geom_vline(xintercept = 0, linewidth=0.15, color="black") +
  geom_col(position = position_dodge(), width=0.75, alpha=0.99) + 
  scale_fill_manual(values=c("HC genotype "= parameters$genotype$palette[[2]], 
                             "HF genotype "= parameters$genotype$palette[[1]]),
                    name="Genotype") + 
  geom_vline(xintercept = -log10(.05), linetype="dashed", linewidth=0.25) +
  xlab("-log<sub>10</sub>P for Metabolite set enrichment") + ylab("") +
  ggplot_ms + 
  theme(legend.key.size = unit(0.35, "cm"),
        strip.background = element_blank(),
        strip.text.x = element_text(size=8, face="bold"),
        legend.title = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA),
        strip.text = element_text(face="bold", size=10),
        axis.title.x = element_markdown(size=8),
        axis.text.x = element_text(size=8, color="black"),
        axis.text.y = element_text(size=8, color="black")) ; fig2d

fig2d %>% ggsave(filename="../output/fig2d_pathways_v3.pdf", height=2.5, width=6.5)

```


## Primary bile acid associations
```{r}
scale_y_symmetric <- function(data, var, buffer = 0.05) {
  max_val <- max(abs(data[[var]]), na.rm = TRUE)
  max_val <- max_val * (1 + buffer)
  scale_y_continuous(limits = c(-max_val, max_val))
}

## Gather bile acids to plot
bile_acids_to_plot <- c("GCA", "GCDCA", "GDCA", "GUDCA", "TCA", "TCDCA", "TDCA", "TUDCA")
bile_acids_to_plot <- bile_acids$HMDB[match(bile_acids_to_plot, bile_acids$Abbrev)]

# Determine order for bileacids by strength
bileacids_ordered <- res_mmtt_metab_time_bygeno %>% 
  filter(p<0.05/30 & beta/log(2) > 0.5) %>%
  filter(genotype == "HC genotype" & outcome %in% bile_acids_to_plot) %>%
  arrange(p)

## Create dataframe with log(fold_change) for bile acid metabolites: FC = log(m120) - log(m0)
analysis2 <- readRDS("../data/processed/premier_analysis2.rda")
bileacids_fc.df <- lapply(names(bileacids.all), function(ba) {
  analysis2 %>% select(id, genotype, time, ba) %>%
    mutate_at("time", ~paste0("m", .)) %>%
    filter(time %in% c("m0", "m120")) %>%
    pivot_wider(names_from=time, values_from=ba) %>% 
    mutate(diff=m120-m0) %>%
    rename_with(., ~gsub("diff", ba, .)) %>%
    select(id, genotype, ba)
  }) %>% reduce(full_join, by=c("id", "genotype"))


# =================================
## Sumary-level data plots
# =================================

fig2e <- bileacids_fc.df %>% 
  pivot_longer(bile_acids_to_plot) %>% 
  mutate_at("name", ~bileacids.all[name]) %>%
  mutate_at("genotype", ~relevel(., ref="HC genotype")) %>%
  group_by(genotype, name) %>% filter(!is.na(genotype)) %>%
  reframe(n=n(), mean=mean(exp(value)), sd=sd(exp(value))) %>% mutate(se=mean/sqrt(n)) %>%
  ggplot(aes(x=name, group=genotype, y=mean, ymin=mean-se, ymax=mean+se, color=genotype)) +
  geom_hline(yintercept = 1, linewidth=0.25, color="black") +
  geom_point(size=2, position=position_dodge(0.35)) + geom_errorbar(width=0.15, linewidth=0.45, position=position_dodge(0.35)) +
  scale_color_manual(values=parameters$geno$palette, name=parameters$geno$label, labels = c(expression(HC[PGS]), expression(HF[PGS]))) + 
  scale_y_continuous(limits=c(0,16), breaks=c(1,5,10,15)) +
  theme_bw() + ggplot_ms + 
  ylab(sprintf("120 min fold change")) + xlab("") + #\n(mean \u00B1 SE)
  theme(panel.background = element_blank(),
        panel.grid.minor.y = element_line(),
        axis.text.x = element_text(color="black", size=10, angle=35, hjust=1, vjust=1), 
        axis.text.y = element_text(size=11), axis.title.y = element_text(color="black", size=11),
        legend.direction = "horizontal", legend.title = element_blank(),
        legend.position = c(0.015, 0.9), legend.justification = c(0,0.5),
        legend.background = element_rect(fill="white", color = "black"),
        legend.text = element_text(size=10),
        legend.margin = margin(0.01,1.5,0.5,0.5,"mm")) ; fig2e

fig2e %>% ggsave(filename="../output/fig2e_bafoldchange_v3.pdf", height=3, width=4.95)

```

# Heat Map
```{r}
# ============================================================
## Heat Map of Bile Acid levels and clinical metabolites
# ==============================================================
library(ComplexHeatmap) ; library(circlize)
clinvars <- c("glucose", "insulin", "tg", "ldl", "hdl")
clinvars.lab <- c("Glucose", "Insulin", "TG", "LDL", "HDL")
names(clinvars.lab) <- clinvars

lm_ba_clin <- fread("../output/tab_res_ba_clinvars_spearman.csv") %>%
  filter(endsWith(ba, "120fc")) %>%
  filter(!grepl("iAUC", y) & !grepl("30",y), !grepl("180",y)) %>%
  separate(y, into=c("outcome", "time"), sep="_") %>%
  mutate(exposure=bileacids.all[gsub("_.*","",ba)]) %>%
  # Filter to only BA included above
  filter(gsub("_.*", "", ba) %in% bile_acids_to_plot)

hm_ba_clin <- lm_ba_clin %>% 
  arrange(p) %>%
  rowwise() %>% mutate(Outcome=factor(outcome, levels=c(clinvars), labels=c("Glucose", "Insulin","TG", "LDL", "HDL"))) %>%
  mutate(Outcome = paste0(Outcome, ", ", time, " min")) %>%
  rename(Exposure = exposure)

# Create heatmap matrix (beta values)
hm_df <- hm_ba_clin %>%
  select(Exposure, cor, Outcome) %>%
  pivot_wider(names_from = Outcome, values_from = cor) 

hm_mat <- as.matrix(hm_df %>% select(-Exposure))
rownames(hm_mat) <- hm_df$Exposure

# Draw once to get clustered row/column order
ht_base <- Heatmap(hm_mat,
                   cluster_rows = TRUE,
                   cluster_columns = TRUE)

ht_drawn <- draw(ht_base)
hm_rows <- row_order(ht_drawn)
hm_cols <- column_order(ht_drawn)

# Reorder the heatmap matrix
hm_plot <- hm_mat[hm_rows, hm_cols]

# Create matching p-value matrix with reordered rows/columns
hm_p <- hm_ba_clin %>%
  select(Exposure, Outcome, p) %>%
  pivot_wider(names_from = Exposure, values_from = p) %>%
  mutate(Outcome = factor(Outcome, levels = colnames(hm_plot))) %>%
  arrange(Outcome) %>%
  select(Outcome, rownames(hm_plot))

hm_p_mat <- as.matrix(hm_p %>% select(-Outcome))
rownames(hm_p_mat) <- hm_p$Outcome

# 6. Define cell_fun with correct indexing
cell_fun <- function(j, i, x, y, width, height, fill) {
  pval <- hm_p_mat[i, j]
  if (!is.na(pval)) {
    if (pval < 0.01) {
      grid.text("**", x, y, gp = gpar(fontsize = 10, fontface = "bold"))
    } else if (pval < 0.05) {
      grid.text("*", x, y, gp = gpar(fontsize = 10, fontface = "bold"))
    }
  }
}

#hm_palette <- colorRamp2(c(-2,0,2), c("blue", "white", "red"))
hm_palette <- colorRamp2(c(-0.7,0,0.7), c(palettes$NatExt$Greens[3], "white", palettes$NatExt$Purples[3]))

# Final plot with annotations in correct places
fig2f <- Heatmap(t(hm_plot),
        name = "beta",
        row_names_side = "left", row_names_gp = gpar(fontsize=9),
        column_names_side = "bottom", column_names_gp = gpar(fontsize=8.5),
        #column_names_rot = 45,
        cluster_rows = FALSE,
        cluster_columns = FALSE,
        cell_fun = cell_fun,
        #row_labels = c("TG", "HDL", "Insulin", "LDL", "Glucose"),
        col = hm_palette,
        height = unit(4,"cm"), width=unit(3.25,"cm"),
        heatmap_legend_param = list(title=expression(phantom(0) * italic(ρ)),
                                    legend_title_gp = gpar(fontsize = 12),
                                    legend_text_gp = gpar(fontsize=10),
                                    title_position = "topleft")) ; fig2f
#pdf("../output/fig2f_hm_baclinvars_v3.pdf", height=4, width=3.5) ; fig2f ; dev.off()
```


## Metabolomics analysis for self-selected meal

```{r}
tab_res_ssmt_metab_time_bymealxgeno <- fread("../output/tab_res_ssmt_metab_time_bymealxgeno.csv")

res_ssmt_metab_time_bymealxgeno <- tab_res_ssmt_metab_time_bymealxgeno %>% 
  mutate(beta=beta/log(2)) %>%
  filter(Exposure == "Time_360") %>%
  filter( !startsWith(outcome, "HMDB0000932")) %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub("Time_", "", .), " min")) 

## Metabolite Lists
hchc <- res_ssmt_metab_time_bymealxgeno %>% filter(genotype == "HC genotype" & meal_type == "HC meal") %>% filter(p<0.05/30) %>% arrange(p) %>% pull(outcome)
hfhc <- res_ssmt_metab_time_bymealxgeno %>% filter(genotype == "HF genotype" & meal_type == "HC meal") %>% filter(p<0.05/30) %>% arrange(p) %>% pull(outcome)
hchf <- res_ssmt_metab_time_bymealxgeno %>% filter(genotype == "HC genotype" & meal_type == "HF meal") %>% filter(p<0.05/30) %>% arrange(p) %>% pull(outcome)
hfhf <- res_ssmt_metab_time_bymealxgeno %>% filter(genotype == "HF genotype" & meal_type == "HF meal") %>% filter(p<0.05/30) %>% arrange(p) %>% pull(outcome)

## Counting UNIQUE metabolites in each group for MS
hchc.unq <- hchc[!hchc %in% hfhc] ; length(hchc.unq) # 23 unique metabolites for HC/HC -- > now 8
hfhc.unq <- hfhc[!hfhc %in% hchc] ; length(hfhc.unq) # 101 unique metabolites for HF/HC --> now 70
hchf.unq <- hchf[!hchf %in% hfhf] ; length(hchf.unq) # 120 unique metabolites for HC/HF --> now 41
hfhf.unq <- hfhf[!hfhf %in% hchf] ; length(hfhf.unq) # 4 unique metabolites for HF/HF --> now 6


## Intersection at each time point (metabolites changing in BOTH genotypes)
hc <- res_ssmt_metab_time_bymealxgeno %>% filter(outcome %in% c(intersect(hchc, hfhc))) %>%
  arrange(p) %>% pull(outcome) 
hf <- res_ssmt_metab_time_bymealxgeno %>% filter(outcome %in% c(intersect(hchf, hfhf))) %>%
  arrange(p) %>% pull(outcome) 

## Metabolite Labels - top 5 && all bile acids
hchc.labs <- c(hchc.unq[1:5], names(bileacids.all)[c(3,6)]) # Include GCA & GDCA; EXCLUDE HMDB0000362 (for oberlaps)
hfhc.labs <- c(hfhc.unq[1:10], names(bileacids.all)[c(2:3,6)]) # Include GCA & GDCA & TDCA 
hchf.labs <- c(hchf.unq[1:10]) #, names(bileacids.all)) 
hfhf.labs <- c(hfhf.unq[1:10]) #, names(bileacids.all)) 

```

```{r}

## Replace BAs with abbreviations
res_ssmt_metab_time_bymealxgeno <- res_ssmt_metab_time_bymealxgeno %>% 
   mutate(Outcome = ifelse(outcome %in% names(bileacids.all), bileacids.all[outcome], Outcome))

# HC genotype x HC meal
bold_ba <- names(bileacids.all)[which(names(bileacids.all) %in% hchc)]
p_v.hchc <- plot_volcano.fun(
  res_ssmt_metab_time_bymealxgeno %>% 
    mutate(Lab = ifelse(meal_type == "HC meal" & outcome %in% hchc.labs, Outcome, NA)) %>% 
    filter(genotype == "HC genotype" & meal_type == "HC meal"), add_labels = T, bolded_labels = bold_ba,
  col1="#E96900", col2="#E8AA80", beta_threshold = 0.25, p_threshold = 0.05/30) +
  facet_grid(cols=vars(meal_type)) + 
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey60", size=0.35) +
  theme(plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.y = element_text(size=12), axis.text.y = element_text(size=10),
        strip.text = element_text(face="bold", size=10)) + 
  #geom_text(data = data.frame(label="HC genotype (N = 12)", x=-8.35, y=12.35), aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
  coord_cartesian(ylim=c(0,5.5), xlim=c(-4,5.5)) + 
  scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(-4,6,2)); p_v.hchc

# HC genotype x HF meal
bold_ba <- names(bileacids.all)[which(names(bileacids.all) %in% hchf)]
p_v.hchf <- plot_volcano.fun(
  res_ssmt_metab_time_bymealxgeno %>% 
    mutate(Lab = ifelse(meal_type == "HF meal" & outcome %in% hchf.labs, Outcome, NA)) %>% 
    filter(genotype == "HC genotype" & meal_type == "HF meal"), add_labels = T, bolded_labels = bold_ba,
  col1="#F29741", col2="#F0C398", beta_threshold = 0.25, p_threshold = 0.05/30) +
  facet_grid(cols=vars(meal_type)) + 
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey60", size=0.35) +
  theme(plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        strip.text = element_text(face="bold", size=10)) + 
  coord_cartesian(ylim=c(0,5.5), xlim=c(-4,5.5)) + 
  scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(-4,6,2)); p_v.hchf

# HF genotype x HC meal
bold_ba <- names(bileacids.all)[which(names(bileacids.all) %in% hfhc)]
p_v.hfhc <- plot_volcano.fun(
  res_ssmt_metab_time_bymealxgeno %>% 
    mutate(Lab = ifelse(meal_type == "HC meal" & outcome %in% hfhc.labs, Outcome, NA)) %>% 
    filter(genotype == "HF genotype" & meal_type == "HC meal"), add_labels = T, bolded_labels = bold_ba,
  col1="#5496CE", col2="#A2BFDF", beta_threshold = 0.25, p_threshold = 0.05/30) +
  facet_grid(cols=vars(meal_type)) + 
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey60", size=0.35) +
  theme(plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_blank(), axis.text.x = element_text(size=10),
        axis.title.y = element_text(size=12), axis.text.y = element_text(size=10),
        strip.text = element_blank()) + 
  coord_cartesian(ylim=c(0,6), xlim=c(-4,5.5)) + 
  scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(-4,6,2)); p_v.hfhc


# HF genotype x HF meal
bold_ba <- names(bileacids.all)[which(names(bileacids.all) %in% hfhf)]
p_v.hfhf <- plot_volcano.fun(
  res_ssmt_metab_time_bymealxgeno %>% 
    mutate(Lab = ifelse(meal_type == "HF meal" & outcome %in% hfhf.labs, Outcome, NA)) %>% 
    filter(genotype == "HF genotype" & meal_type == "HF meal"), add_labels = T, bolded_labels = bold_ba,
  col1="#006EAE", col2="#81A7CB", beta_threshold = 0.25, p_threshold = 0.05/30) +
  facet_grid(cols=vars(meal_type)) + 
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey60", size=0.35) +
  theme(plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_blank(), axis.text.x = element_text(size=10),
        axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        strip.text = element_blank()) + 
  coord_cartesian(ylim=c(0,6), xlim=c(-4,5.5)) + 
  scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(-4,6,2)); p_v.hfhf

fig2j <- ggarrange(ggarrange(p_v.hchc, "", p_v.hchf, nrow=1, common.legend = T, 
                             legend="none", widths=c(1,0.02, 0.9)), 
          ggarrange(p_v.hfhc, "", p_v.hfhf, nrow=1, common.legend = T, legend="none", 
                    widths=c(1, 0.02, 0.9)), nrow=2) ; fig2j
fig2j %>% ggsave(filename="../output/fig2j_ssmt_metab_v3_noba.pdf", width=6, height=4.5)
```

```{r}
## Descriptive summary of characteristics of unique metabolites by genotype and meal type
metab_dict %>% filter(Input.name %in% hchc.unq)
metab_dict %>% filter(Input.name %in% hchf.unq)
metab_dict %>% filter(Input.name %in% hfhc.unq)
metab_dict %>% filter(Input.name %in% hfhf.unq) 

## Descriptive summary of common metabolites for each meal, across genotype
metab_dict %>% filter(Input.name %in% intersect(hchc, hfhc))
intersect(hchf, hfhf)

```

## Supplementary table of bile acid changes by genotype in self-selection meal
```{r}

analysis2 <- readRDS("../data/processed/premier_analysis2.rda")
bileacids_fc.df <- lapply(names(bileacids.all), function(ba) {
  analysis2 %>% select(id, genotype, time, ba) %>%
    mutate_at("time", ~paste0("m", .)) %>%
    filter(time %in% c("m0", "m120")) %>%
    pivot_wider(names_from=time, values_from=ba) %>% 
    mutate(diff=m120-m0) %>%
    rename_with(., ~gsub("diff", ba, .)) %>%
    select(id, genotype, ba)
  }) %>% reduce(full_join, by=c("id", "genotype"))


# =================================
## Sumary-level data plots
# =================================

fig2e <- bileacids_fc.df %>% 
  pivot_longer(bile_acids_to_plot) %>% 
  mutate_at("name", ~bileacids.all[name]) %>%
  mutate_at("genotype", ~relevel(., ref="HC genotype")) %>%
  group_by(genotype, name) %>% filter(!is.na(genotype)) %>%
  reframe(n=n(), mean=mean(exp(value)), sd=sd(exp(value))) %>% mutate(se=mean/sqrt(n)) %>%
  ggplot(aes(x=name, group=genotype, y=mean, ymin=mean-se, ymax=mean+se, color=genotype)) +
  geom_hline(yintercept = 1, linewidth=0.25, color="black") +
  geom_point(size=2, position=position_dodge(0.35)) + geom_errorbar(width=0.15, linewidth=0.45, position=position_dodge(0.35)) +
  scale_color_manual(values=parameters$geno$palette, name=parameters$geno$label) + 
  scale_y_continuous(limits=c(0,16), breaks=c(1,5,10,15)) +
  theme_bw() + ggplot_ms + 
  ylab(sprintf("120 min fold change")) + xlab("") + #\n(mean \u00B1 SE)
  theme(panel.background = element_blank(),
        panel.grid.minor.y = element_line(),
        axis.text.x = element_text(color="black", size=10, angle=35, hjust=1, vjust=1), 
        axis.text.y = element_text(size=11), axis.title.y = element_text(color="black", size=11),
        legend.direction = "horizontal", legend.title = element_blank(),
        legend.position = c(0.015, 0.9), legend.justification = c(0,0.5),
        legend.background = element_rect(fill="white", color = "black"),
        legend.text = element_text(size=10),
        legend.margin = margin(0.01,1.5,0.5,0.5,"mm")) ; fig2e

fig2e #%>% ggsave(filename="../output/fig2e_bafoldchange_v3.pdf", height=3, width=4.95)


# =============================================
## Bile acids following self-selected meals
# =============================================
res_ssmt_metab_time_bymealxgeno %>%
  filter(outcome %in% bile_acids_to_plot) %>%
  mutate(Beta.CI = sprintf("%s (%s, %s)", round(beta,2), round(lowCI,2), round(upCI,2))) %>%
  select(genotype, meal_type, Outcome, Beta.CI, p) %>%
  mutate_at("p", ~format_p(.)) %>%
  pivot_wider(values_from=c(Beta.CI, p), names_from=c(genotype, meal_type)) %>%
  fwrite("../output/tab_res_ssmt_ba_genoXmeal_betaci.csv")
  
```

##### FIGURE SPECIFICATIONS

```{r}
#2ab
fig2ab <- ggarrange(fig2a,"", fig2b, ncol=1, align="h", heights=c(1.15, 0.15,1)) 
fig2ab %>% ggsave(filename="../output/fig2ab_mmtt.pdf", width=6.5, height=6)

#2c-v1
fig2c <- ggarrange("", ggarrange(p_v.hc, p_v.hf, ncol=1, common.legend = F, 
                                 legend = "none", heights=c(1.15,1.05)), widths=c(0.05,1)) 
fig2c %>% ggsave(filename="../output/fig2c_mmtt_metab_4.pdf", width=6, height=5.25)

#2d
fig2d %>% ggsave(filename="../output/fig2d_pathways.pdf", height=2.5, width=7.5)

#2g
ggarrange("", fig2g, labels = c("", ""), widths=c(0.05,1)) %>% 
  ggsave(filename="../output/fig2g_mealxgeno.pdf", height=6.5, width=2.5)

#2h
fig2h <- ggarrange(p_ssmt_glu_indiv, "", p_ssmt_insu_indiv, legend = "none", 
                   nrow=3, heights=c(1.05,0.025,1.0), align="h") ; fig2h %>% ggsave(filename="../output/fig2h_ssmt.pdf", width=7, height=5)

# fig2j
fig2j %>% ggsave(filename="../output/fig2j_ssmt_metab.pdf", width=6, height=4.5)

fig2legend <- fig2g + theme(legend.direction = "horizontal",
              legend.text = element_text(size=9),
              legend.title = element_text(size=10)) 
fig2legend %>% ggsave(filename="../output/fig2_legend.pdf", height=6.5, width=6.5)

#=======REVISED========#
#2c-v2
fig2c <- ggarrange("", ggarrange(p_v.hc, p_v.hf, ncol=1, common.legend = F, 
                                 legend = "none", heights=c(1.15,1.05)), widths=c(0.05,1)) 
fig2c %>% ggsave(filename="../output/fig2c_mmtt_metab_v2.pdf", width=6, height=5.25)

```



## ALL TABLES 


```{r, echo=F, warning=F}

## Table 1. Participant characteristics - demographics, anthropometrics & fasting metaboliteS
rbind.data.frame(
  fread("../output/tab_descr_demographics_genecat.csv", header = T),
  fread("../output/tab_descr_metabolites_genecat.csv", header = T)) %>% 
  kable(caption="Table 1")


## Table S3. Effect of genotype on **postprandial** glucose & insulin responses (MMTT)
results_mmtt <- fread("../output/tab_res_mmtt_postprandial_mgdL.csv") %>%
  mutate(beta=as.numeric(beta)*-1) %>% # Convert to HF reference group
  mutate(Beta.SE=ifelse(is.na(beta)==T, "-", sprintf("%s (%s, %s)", round(beta,2), round(beta-1.96*as.numeric(se),2), round(beta+1.96*as.numeric(se),2)))) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  mutate_at("Exposure", ~gsub(".*HC", "HF", gsub("Genotype_", "Genotype", gsub("time", "", .)))) %>%
  mutate_at("Exposure", ~ifelse(grepl("x", .)==T, paste0(., " min"), .)) %>%
  select(Meal.Type, Model, Outcome, Effect, Exposure, Beta.SE, P=P_signif, Anova.P=anovaP_signif) %>%
  filter(Model == "primary") %>%
  fwrite("../output/Tab_S3_mmtt_postprandial_print.csv")

## Table S4. Effect of genotype on **iAUC** glucose/insulin responses to a standardized mixed meal
# Model: lm(metabolite_120iAUC ~ genetic_category.lab+age+sex+bmi+PC1+PC2+PC3, data=analysis)
fread(paste0("../output/tab_res_mmtt_iAUCpos.csv")) %>%
  filter(Model!="empty") %>%
  mutate(Metabolite=str_to_sentence(gsub("[_].*", "", Outcome))) %>% 
  mutate(Outcome=gsub(".*[_]", "", gsub("iAUC.*", "min iAUC", Outcome))) %>%
  select(Meal.Type, Model, Effect, Metabolite, Outcome, Exposure, Beta.SE, P=P_signif, AnovaP=anovaP_signif) %>%
  fwrite("../output/Tab_S4_mmtt_iauc_print.csv")


#### Self-Selected Meal Tolerance Test (Aim 2a)
# Demographics, anthropometrics & fasting metabolites **By meal selection**
print_summary_table(
      analysis, vars_to_summarize = c(meal_choice="Meal Selection"), p_adjust = "none", 
      var_strata = "genotype", var_strata_order = c("HC genotype", "HF genotype"),
      p_types = "descriptive", p_smalln=T, factor_vars = "meal_choice") %>% kable()
rbind.data.frame(
      fread("../output/tab_descr_demographics_mealchoice.csv", header = T), 
      fread("../output/tab_descr_metabolites_mealchoice.csv", header = T)) %>% 
  fwrite("../output/Tab_S7_descr_mealchoice_print.csv")


#### Postprandial glucose & insulin, by meal selection
## Suppl Fig X) iAUC (pos) by meal type 
p_ssmt_pp_meal <- ggarrange(
  "", plot_ppXtime_stratified("glucose", times=c(235,270,300,360), strata = "meal_choice"), 
  "", plot_ppXtime_stratified("insulin", times=c(235,270,300,360), strata = "meal_choice"),
  nrow=1, widths=c(0.05, 1, 0.05,1), common.legend = T, legend = "top")
p_ssmt_iauc_meal <- ggarrange(
  "", plot_iAUC_strat("glucose", strata = "meal_choice", iAUC=360, fancy_x = T),
  "", plot_iAUC_strat("insulin", strata = "meal_choice", iAUC=360, fancy_x = T),
  nrow=1, widths=c(0.05,1,0.05,1), common.legend = T, legend = "none")
figSx <- ggarrange(p_ssmt_pp_meal, p_ssmt_iauc_meal, common.legend = T, legend = "none", heights=c(1.15,1),
                   nrow=2, labels=c("a", "b"), hjust=0.5, vjust=0.95, font.label = c(size=16), align="hv") ; figSx

#ggarrange(plot_glu_meal, plot_insu_meal, nrow=2, common.legend = T, heights=c(0.95, 0.95), align="hv") %>%
    #ggsave(filenam="../output/fig_multipanel_ss_mealtype_summary_v3.pdf", height=6,width=10)


## Table SX. Self-Selected Meals **


results_selected <- rbind.data.frame(
  fread("../output/tab_result_postprandial_selected_allmodels_bymeal_HFref_mgdL.csv"),
  fread("../output/tab_result_postprandial_selected_allmodels_bygeno_HFref_mgdL.csv")) %>%
  dplyr::select(Meal.Type, Strata, Level, Model, Outcome, Effect, Exposure, Beta.SE, P=P_signif, Anova.P=anovaP_signif)

## Effect of genotype on **postprandial** glucose & insulin responses to a self-selected meal
results_selected %>% 
  filter(Strata=="Meal Choice") %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  filter(Model == "primary") %>%
  arrange(Level) %>%
  dplyr::select(-Strata, -Model) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  #fwrite("../output/tab_result_lme_glycemic_selected_postprandial_bymeal_HFref_print.csv") 
  kable(caption="Stratified by Meal Choice, model adjusting for time0, postprandial glycemic traits")

## p-values for baseline (time 0) glucsoe and insulin
t.test(tg_235 ~ meal_choice, data=analysis) ; tapply(analysis$tg_235, analysis$meal_choice, mean_sd)
t.test(ldl_235 ~ meal_choice, data=analysis) ; tapply(analysis$ldl_235, analysis$meal_choice, mean_sd)
summary(lm(tg_235 ~ meal_choice+age+sex+PC1z+PC2z+PC3z+bmi, data=analysis)) # 0.64333 
summary(lm(ldl_235 ~ meal_choice+age+sex+PC1z+PC2z+PC3z+bmi, data=analysis)) # 0.64333 


## Meal choice effect, for different genotypes, on postprandial responses to self-selected meal (stratified by genetic category)**
results_selected %>% 
  filter(Strata=="Genotype") %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  filter(Model == "primary") %>%
  arrange(Level) %>%
  select(-Strata, -Model) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  #fwrite("../output/tab_result_lme_glycemic_selected_postprandial_bygeno_print.csv") 
  kable(caption="Stratified by Meal Choice, model adjusting for time0, postprandial glycemic traits")

## Table SX. Effect of genotype on **iAUC** glucose & insulin responses to a self-selected meal
# **Model(s):** lm(metabolite_iAUC~genetic_category+age+sex+PC1+PC2+PC3+meal_choice+[metabolite_235], data=analysis)
fread(paste0("../output/tab_result_lm_glycemic_selected_iAUC_allModels_v3.csv")) %>%
  mutate(Metabolite=str_to_sentence(gsub("[_].*", "", Outcome))) %>% 
  mutate(Outcome=gsub(".*[_]", "", gsub("iAUC.*", "min iAUC", Outcome))) %>%
  filter(Strata=="Meal Choice") %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  filter(Model != "AdjTime0") %>%
  arrange(Level) %>%
  select(Model, Level, N, Metabolite, Outcome, Exposure, Beta.SE, P=P_signif, AnovaP=anovaP_signif) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  kable()

fread(paste0("../output/tab_result_lm_glycemic_selected_iAUC_allModels_v3.csv")) %>%
  mutate(Metabolite=str_to_sentence(gsub("[_].*", "", Outcome))) %>% 
  mutate(Outcome=gsub(".*[_]", "", gsub("iAUC.*", "min iAUC", Outcome))) %>%
  filter(Strata=="Genetic Category") %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  filter(Model == "AdjTime0") %>%
  arrange(Strata) %>%
  select(Model, Level, N, Metabolite, Outcome, Exposure, Beta.SE, P=P_signif, AnovaP=anovaP_signif) %>%
  #fwrite("../output/tab_result_120iauc_selected_bygeno_print.csv")
  kable()


## Metabolomics table for SSMT
tab_metab_ssmt_bymealxgeno <- fread("../output/tab_res_ssmt_metab_time_bymealxgeno.csv")
tab_metab_ssmt_bymealxgeno %>%
  filter(Exposure != "Time_(joint)") %>%
  filter(p<0.05) %>%
  mutate(Beta.CI=sprintf("%s (%s, %s)", round(beta,2), round(lowCI,2), round(upCI,2)), P=format_p(p)) %>%
  mutate(gxm=paste(genotype, meal, sep="/")) %>%
  select(genotype, meal=meal_type, outcome, Outcome, Beta.CI, P) %>%
  pivot_wider(names_from=c(genotype), values_from=c(Beta.CI, P)) %>%
  pivot_wider(names_from=c(meal), values_from=starts_with(c("Beta.CI", "P"))) %>%
  fwrite("../output/tab_res_ssmt_metab_time_bymealxgeno_p05_print.csv", row.names = T)

a <- tab_metab_ssmt_bymealxgeno %>%
  filter(Exposure != "Time_(joint)") %>%
  filter(p<0.05) %>%
  mutate(Beta.CI=sprintf("%s (%s, %s)", round(beta,2), round(lowCI,2), round(upCI,2)), P=format_p(p)) %>%
  mutate(gxm=paste(genotype, meal, sep="/")) %>%
  select(genotype, meal=meal_type, outcome, Outcome, Beta.CI, P) %>%
  pivot_wider(names_from=c(genotype), values_from=c(Beta.CI, P)) %>%
  pivot_wider(names_from=c(meal), values_from=starts_with(c("Beta.CI", "P"))) 
dim(a)
length(unique(a$outcome))

```


## EOF

