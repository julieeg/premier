---
title: "PREMIER results for PNF Abstract"
output: html_document
theme: united
date: "2025-01-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, fig.width = 10, fig.height = 5)

#Load libraries
library(Hmisc)
library(tidyverse)
library(data.table)
library(devtools)
library(ggpubr)
library(knitr)
library(ggrepel)
library(ggtext) # element_markdown (for italics)

# Load pantry "package"
lapply(list.files("../../pantry/functions/", recursive = T, full.names = T), source)

# Load data files
analysis <- readRDS("../data/processed/premier_analysis.rda")

# Set plot parameters
parameters <- list(
  total = list(label="Total cohort", palette=palettes$NatMainBackground2x2[1]),
  genotype = list(label = "Genotype", 
                  strata = "genotype", 
                  #palette = palettes$NatMainAccent3$Level3[1:2]) 
                  palette = c("HF genotype"="#156082", "HC genotype"="#E97132"),
                  levels=c("HC genotype", "HF genotype"), levels_fancy=c("HC\ngenotype", "HF\ngenotype")),
  meal_choice = list(label = "Meal type", strata="meal_choice", 
                     #palette = palettes$NatMainAccent3$Level5[1:2],
                     palette = c("HC meal"="#F2AA84", "HF meal"="#82A0B2"),
                     levels=c("HC meal", "HF meal"), levels_fancy=c("HC\nmeal", "HF\nmeal")), 
  gene_x_meal = list(label = "Genotype x Meal type", 
                     strata="genetic_cat_x_meal_choice", 
                     #palette = c(palettes$NatMainAccent3$Level3[1:2], palettes$NatMainAccent3$Level5[1:2])[c(1,3,4,2)],
                     palette = c("#E97132", "#F2AA84", "#82A0B2", "#156082"),
                     levels=c("HC genotype\nx HC meal", "HC genotype\nx HF meal", "HF gneotype\nx HC meal", "HF genotype\nx HF meal"),
                     levels_fancy=c("HC genotype\nx HC meal", "HC genotype\nx HF meal", "HF gneotype\nx HC meal", "HF genotype\nx HF meal"))
  )

genotypes <- c("HC genotype", "HF genotype")

ggplot_ms <- theme(
  panel.grid = element_line(linewidth=0.25),
  panel.grid.minor.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  legend.background = element_rect(linewidth = 0.35, color="black"),
  #legend.margin = margin(0.25,0.25,0.25,0.25,unit="pt"),
  legend.margin = margin(rep(0.15,4), unit="cm"),
  legend.title = element_text(face="bold"),
  legend.text = element_text(size=10)
)
```


```{r}
units <- c("", "_mmol")
Units <- c("(mg/dL)", "(mmol/L)")
Units <- c("mg/dL", "mmol/L")

unit=units[1]
Unit=Units[1]
```


##### Plotting Functions 
```{r}
# ================================================================
## Spaghetti plot of postprandial responses 
# ================================================================

## individual-level + summary (total) ------------------
# Total --------------------------
plot_ppXtime_total <- function(metabolite, times=c(0,30,60,120,180,235), palette, data=analysis) {
  palette=parameters$total$palette
  y_label=paste0("Plasma ", metabolite, ", ", Unit)
  
  dat <- data %>% select(id, starts_with(paste0(metabolite, "_"))) %>%
    rename_with(~gsub(metabolite, "x", .), starts_with(metabolite)) %>%
    rename_with(., ~gsub("m", "", gsub("_log", "", .))) %>%
    select(id, paste0("x_", times)) %>%
    pivot_longer(-id, names_sep="_", names_to=c("metabolite", "time")) %>%
    mutate(across(c("time", "value"), ~as.numeric(.)))
  
  dat.summary <- dat %>% 
    filter(time %in% times) %>%
    group_by(time) %>%
    reframe(n=n(), mean=mean(value, na.rm=T), sd=sd(value, na.rm=T)) %>%
    mutate(se=sd/sqrt(n))
  
  dat %>%
    ggplot(aes(x=time, y=value, group=id)) + 
    scale_x_continuous(breaks=times) +
    #geom_vline(xintercept = times[1], color="black", linewidth=0.55) +
    geom_line(alpha=0.55, linewidth=0.25, color=palette) + 
    stat_summary(aes(group = metabolite), geom = "point", fun = mean, size = 2, color=palette) + 
    stat_summary(aes(group = metabolite), geom = "line", fun = mean, linewidth = 1, color=palette) + 
    geom_errorbar(data=dat.summary, aes(x=time, y=mean, ymin=mean-se, ymax=mean+se), color=palette,
                  inherit.aes = F, #position=position_dodge(8),
                  width=5, linewidth=0.75, alpha=0.75) +
    xlab("Time (minutes)") + ylab(y_label) + 
    theme_bw() +
    ggplot_ms 
}


## Stratified; individual-level + summary --------------------------
plot_ppXtime_stratified <- function(metabolite, times = c(0,30,60,120,180,235), 
                                       strata="genotype", data=analysis, p_value=F) {
  strata_var=parameters[[strata]]$strata 
  #y_label=paste(str_to_sentence(metabolite), Unit, " mean \u00B1 SE")
  y_label=paste0("Plasma ", metabolite, ", ", Unit)
  dat <- data %>% select(id, starts_with(metabolite), strata=all_of(strata_var)) %>%
    rename_with(~gsub(metabolite, "x", .), starts_with(metabolite)) %>%
    rename_with(., ~gsub("m", "", gsub("_log", "", .))) %>%
    select(id, strata, paste0("x_", times)) %>%
    pivot_longer(-c(id, strata), names_sep="_", names_to=c("metabolite", "time")) %>%
    mutate(across(c("time", "value"), ~as.numeric(.))) %>%
    group_by(strata, time) %>% 
    filter(is.na(strata)==F) #%>%
    
    #Convert to mg/dL**
    #mutate(value=value*18) 
  
  dat.summary <- dat %>% 
    reframe(n=n(), mean=mean(value, na.rm=T), sd=sd(value, na.rm=T)) %>%
    mutate(se=sd/sqrt(n)) %>% filter(!is.na(strata))
  
  dat %>% 
    ggplot(aes(x=time, y=value, group=id, color=strata)) + 
    scale_x_continuous(breaks=times) +
    #geom_vline(xintercept = times[1], color="grey25", linewidth=1.35) +
    geom_line(alpha=0.55, linewidth=0.25) + 
    #geom_point(size=2.5, position=position_dodge(5.5)) +
    stat_summary(aes(group = strata), geom = "point", fun = mean, size = 2) + 
    stat_summary(aes(group = strata), geom = "line", fun = mean, linewidth = 1) +
    #stat_summary(aes(group = strata), geom = "line", fun = mean, linewidth = 1) +
    geom_errorbar(data=dat.summary, aes(x=time, y=mean, ymin=mean-se, ymax=mean+se, 
                      color=strata, group=strata), inherit.aes = F, #position=position_dodge(8),
                  width=5, linewidth=0.75, alpha=0.75) +
    scale_color_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    scale_y_continuous(expand=c(0.1,0.05)) +
    xlab("Time (minutes)") + ylab(y_label) + 
    #ggtitle(str_to_sentence(metabolite)) +
    theme_bw() + 
    theme(panel.grid = element_line(linewidth=0.25),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.background = element_rect(linewidth = 0.35, color="black"),
          legend.margin = margin(0.1,0.1,0.1,0.1,unit="cm"),
          legend.title = element_text(face="bold"),
          legend.text = element_text(size=10))
}


## Stratified, summary only --------------------------
plot_ppXtime_stratified_sum <- function(metabolite, times = c(0,30,60,120,180), 
                                       strata="genetic_category",data=analysis, spaghetti=F) {
  strata_var=parameters[[strata]]$strata 
  #y_label=paste(str_to_sentence(metabolite), Unit, " mean \u00B1 SE")
  y_label=paste0("Plasma ", metabolite, ", ", Unit)
  data %>% select(id, starts_with(metabolite), strata=all_of(strata_var)) %>%
    rename_with(~gsub(metabolite, "x", .), starts_with(metabolite)) %>%
    rename_with(., ~gsub("m", "", gsub("_log", "", .))) %>%
    select(id, strata, paste0("x_", times)) %>%
    pivot_longer(-c(id, strata), names_sep="_", names_to=c("metabolite", "time")) %>%
    mutate(across(c("time", "value"), ~as.numeric(.))) %>%
    group_by(strata, time) %>% 
    
    #Convert to mg/dL**
    #mutate(value=value*18) %>%
    
    reframe(n=n(), mean=mean(value, na.rm=T), sd=sd(value, na.rm=T)) %>%
    mutate(se=sd/sqrt(n)) %>% filter(!is.na(strata)) %>%
    
    ggplot(aes(x=time, y=mean, ymin=mean-se, ymax=mean+se, group=strata, color=strata)) + 
    scale_x_continuous(breaks=times) +
    geom_vline(xintercept = times[1], color="grey25", linewidth=1.35) +
    geom_line(alpha=0.85, position=position_dodge(5.5), linewidth=1) + 
    geom_point(size=2.5, position=position_dodge(5.5)) +
    geom_errorbar(width=5, linewidth=0.75, alpha=0.85, position=position_dodge(5.5)) +
    scale_color_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    scale_y_continuous(expand=c(0.1,0.05)) +
    xlab("Time (minutes)") + ylab(y_label) + 
    theme_bw()
}



# ====================================
## Mean iAUC (un-stratified)
# ====================================

## Total --------------------------
plot_iAUC_total <- function(metabolite, iAUC=120, iAUC_method=".pos", y_extend=c(0.2,0), data=analysis) {
  metabolite_iAUC=paste0(metabolite,"_", iAUC, "iAUC", iAUC_method)
  p<-data %>% select(id, y=metabolite_iAUC) %>%
    reframe(n=length(y), mean=mean(y), sd=sd(y)) %>%
    mutate(se=sd/sqrt(n), metabolite=metabolite) %>%
    
    ggplot(aes(x=metabolite, y=mean, ymin=mean-se, ymax=mean+se, fill=metabolite)) + 
    geom_bar(stat="identity", width=0.65) + geom_errorbar(width=0.15) +
    scale_fill_manual(values=parameters$total$palette) + 
    xlab("All Participants") + ylab(paste(str_to_sentence(metabolite), Unit, "\n120-min iAUC")) + 
    theme_bw() + theme(legend.position = "none", axis.text.x = element_blank())
    ggplot_extend_ylim(p, y_max_extend=y_extend[1], y_extend[2])
}


## Stratified --------------------------
plot_iAUC_strat <- function(metabolite, iAUC=120, iAUC_method=".pos", y_extend=c(0.15,0), strata, fancy_x=F, data=analysis) {
  strata_var=parameters[[strata]]$strata 
  #y_label=paste(str_to_sentence(metabolite), Unit, " 120-min iAUC")
  y_label=paste0(str_to_sentence(metabolite), ", 120 min iAUC")
  p<-data %>% select(id, starts_with(metabolite) & ends_with(paste0(iAUC,"iAUC", iAUC_method)), strata=all_of(strata_var)) %>%
    rename_at(paste0(metabolite, "_", iAUC, "iAUC", iAUC_method), ~gsub(paste0("[_]", iAUC,"iAUC.*"), "", gsub(metabolite, "value", .))) %>%
    group_by(strata) %>% filter(complete.cases(strata)) %>%
    reframe(n=n(), mean=mean(value), sd=sd(value)) %>% mutate(se=sd/sqrt(n)) %>%
    
    ggplot(aes(x=strata, y=mean, ymin=mean-se, ymax=mean+se, fill=strata)) + 
    geom_bar(stat="identity") + geom_errorbar(width=0.075) +
    xlab(parameters[[strata]]$label) + ylab(y_label) + 
    scale_fill_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    theme_bw() + theme(axis.text.x = element_blank()) 
    p <- ggplot_extend_ylim(p, y_max_extend=y_extend[1], y_extend[2])
    if(fancy_x == T) {
      p <- p + xlab("") + theme(axis.text.x = element_text(vjust=-0.5, color="black")) + 
        scale_x_discrete(labels = parameters[[strata]]$levels_fancy)
      } ; p
}


```


## Participant characteristics 
#### Demographics, anthropometrics & fasting metabolites

**By genetic category**
```{r, echo=F, warning=F}
rbind.data.frame(
  fread("../output/tab_descr_demographics_genecat.csv", header = T),
  fread("../output/tab_descr_metabolites_genecat.csv", header = T)) %>% 
  kable(caption="Table 1")
```

```{r}
## PC projections by Race 
ggarrange(
  analysis %>% ggplot(aes(x=PC1z, y=PC2z, color=Race)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  analysis %>% ggplot(aes(x=PC1z, y=PC3z, color=Race)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  analysis %>% ggplot(aes(x=PC2z, y=PC3z, color=Race)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  common.legend = T, nrow=1)

## PC projections by genotype
ggarrange(
  analysis %>% ggplot(aes(x=PC1z, y=PC2z, color=genotype)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  analysis %>% ggplot(aes(x=PC1z, y=PC3z, color=genotype)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  analysis %>% ggplot(aes(x=PC2z, y=PC3z, color=genotype)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  common.legend = T, nrow=1)

## Removing 1 participant identifying as Black
sensitivity <- analysis %>% filter(Race != "Black")
ggarrange(
  sensitivity %>% ggplot(aes(x=PC1z, y=PC2z, color=genotype)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  sensitivity %>% ggplot(aes(x=PC1z, y=PC3z, color=genotype)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  sensitivity %>% ggplot(aes(x=PC2z, y=PC3z, color=genotype)) +
    geom_point(size=2, alpha=0.75) + theme_bw() + ggplot_ms,
  common.legend = T, nrow=1)

cor.test(sensitivity$PC1z, sensitivity$PC2z) #cor=-0.79
cor.test(sensitivity$PC1z, sensitivity$PC3z) #cor=-0.58
cor.test(sensitivity$PC2z, sensitivity$PC3z) #cor=-0.51
```


##### Postprandial glucose & insulin, overall
```{r, echo=F, fig.width=10, fig.height=8, warning=F}
gluc_y_label=paste0("Glucose", Unit) ;insu_y_label=paste0("Insulin", Unit)

plot_glu_total <- ggarrange(plot_ppXtime_total("glucose"), "", plot_iAUC_total("glucose"),nrow=1, widths=c(1.75, 0.1, 0.65))
plot_insu_total <- ggarrange(plot_ppXtime_total("insulin"), "", plot_iAUC_total("insulin"),nrow=1, widths=c(1.75, 0.1, 0.65))

ggarrange(plot_glu_total, plot_insu_total, nrow=2) #%>%
  #ggsave(filename="../output/fig_postprandial_metab_total.pdf", height=3.5, width=8)

## Postprandial responses
p_postpran_total <- ggarrange("", plot_ppXtime_total("glucose"), "", plot_ppXtime_total("insulin"), nrow=1,
                              widths=c(0.05,1,0.05,1), labels=c("", "A", "", "B"), hjust=0.75, vjust=1, font.label = c(size=16))
p_postpran_total %>% ggsave(filename="../output/fig_postprandial_standard_total_v2.pdf", height=3,width=8)

## TO ADD P-VALUES TO THE PLOT
anova(lmerTest::lmer(glucose~time+age+sex+(1|id), data=postprandial %>% filter(time %in% c(0,30,60,120,180,235))))
anova(lmerTest::lmer(insulin~time+age+sex+(1|id), data=postprandial %>% filter(time %in% c(0,30,60,120,180,235))))
```


### Statistical Analyses (Aim 1a)
#### *Mixed-Meal Tolerance Tests*

##### Effect of genotype on postprandial resopnses over 4 hours including individual-level data
Postprandial responses by genotype for 0-240
```{r}
p_glu_geno_indiv <- plot_ppXtime_stratified("glucose", times = c(0,30,60,120,180,235)) 
p_insu_geno_indiv <- plot_ppXtime_stratified("insulin", times = c(0,30,60,120,180,235))
ggarrange("", p_glu_geno_indiv, "", p_insu_geno_indiv, common.legend = T, legend = "bottom",
          nrow=1, widths=c(0.05,1,0.05,1), labels=c("", "A", "", "B"), hjust=0.75, vjust=1.35, font.label = c(size=16)) #%>%
  #ggsave(filename="../output/fig_postprandial_standard_genotype.pdf", height=3.5,width=8)
```


##### Effect of genetic category on **postprandial** glucose & insulin responses to a standardized mixed meal
```{r, echo=F}
# Primary model
results_mmtt <- fread("../output/tab_result_mmtt_postprandial_mgdL.csv") %>%
  mutate(beta=as.numeric(beta)*-1) %>% # Convert to HF reference group
  mutate(Beta.SE=ifelse(is.na(beta)==T, "-", sprintf("%s (%s, %s)", round(beta,2), round(beta-1.96*as.numeric(se),2), round(beta+1.96*as.numeric(se),2)))) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  mutate_at("Exposure", ~gsub(".*HC", "HF", gsub("Genotype_", "Genotype ", .))) %>%
  select(Meal.Type, Model, Outcome, Effect, Exposure, Beta.SE, P=P_signif, Anova.P=anovaP_signif)

results_mmtt %>% #filter(grepl("Postprandial", Outcome)) %>%
  filter(Model == "primary") %>%
  pivot_wider(values_from=c(Beta.SE, P, Anova.P), names_from=Outcome) %>%
  select(Model, Effect, Exposure, ends_with("Glucose"), ends_with("Insulin")) %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  #fwrite("../output/tab_result_lm_glycemic_mmtt_adjtime_print_HFref.csv")
  kable(caption = "Summary table: lmer with random effect participant ID adjusting for time (main and interaction)")

## BMI model
results_mmtt_bmi <- results_mmtt %>%
  filter(Model == "bmi") %>%
  mutate_at("Exposure", ~gsub(".*HC", "HC", gsub("Genotype_", "Genotype ", .))) %>%
  select(Meal.Type, Model, Outcome, Effect, Exposure, Beta.SE, P, Anova.P)

results_mmtt_bmi %>% 
  pivot_wider(values_from=c(Beta.SE, P, Anova.P), names_from=Outcome) %>%
  select(Model, Effect, Exposure, ends_with("Glucose"), ends_with("Insulin")) %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  #fwrite("../output/tab_result_lm_glycemic_mmtt_adjtime_bmi_print_HFref.csv")
  kable(caption = "Summary table: lmer with random effect participant ID adjusting for time (main and interaction) in BMI adjusted model")

## Effect of genetic category on **iAUC** glucose/insulin responses to a standardized mixed meal
# Model: lm(metabolite_120iAUC ~ genetic_category.lab+age+sex+bmi+PC1+PC2+PC3, data=analysis)
fread(paste0("../output/tab_result_mmtt_postprand_iAUC.csv")) %>%
  filter(Model=="primary") %>%
  mutate(Metabolite=str_to_sentence(gsub("[_].*", "", Outcome))) %>% 
  mutate(Outcome=gsub(".*[_]", "", gsub("iAUC.*", "min iAUC", Outcome))) %>%
  select(Meal.Type, Model, Effect, Metabolite, Outcome, Exposure, Beta.SE, P=P_signif, AnovaP=anovaP_signif) %>%
  #fwrite("../output/tab_result_lm_120iauc_primary_print.csv")
  kable(caption="Model with adjustment for time 0, mixed-effects models, postprandial")
``` 


## Supplementary Figure of iAUC
```{r}

plot_iAUC_strat <- function(metabolite, iAUC=360, y_extend=c(0.15,0), iAUC_method=".pos", strata="genotype", panel="meal_choice", fancy_x=F, data=analysis) {
  strata_var=parameters[[strata]]$strata 
  #y_label=paste(str_to_sentence(metabolite), Unit, " 120-min iAUC")
  y_label=paste0(str_to_sentence(metabolite), ", 120 min iAUC")
  p <- data %>% select(id, starts_with(metabolite) & ends_with(paste0(iAUC,"iAUC.net")), strata=all_of(strata_var), panel=all_of(panel)) %>%
    rename_at(paste0(metabolite, "_", iAUC, "iAUC.net"), ~gsub(paste0("[_]", iAUC,"iAUC.*"), "", gsub(metabolite, "value", .))) %>%
    group_by(strata, panel) %>% filter(complete.cases(strata)) %>%
    reframe(n=n(), mean=mean(value), sd=sd(value)) %>% mutate(se=sd/sqrt(n)) %>%
    mutate_at("panel", ~factor(., levels=c("HC meal", "HF meal"))) %>%
    mutate_at("strata", ~factor(., levels=genotypes)) %>%
    
    ggplot(aes(x=strata, y=mean, ymin=mean-se, ymax=mean+se, fill=strata)) +
    facet_grid(cols=vars(panel)) +
    geom_bar(stat="identity") + geom_errorbar(width=0.075) +
    xlab(parameters[[strata]]$label) + ylab(y_label) + 
    scale_fill_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    theme_bw() + theme(axis.text.x = element_blank()) + 
    ggplot_ms + 
    theme(strip.background = element_blank(), strip.text=element_text(face="bold"))
    
    p <- ggplot_extend_ylim(p, y_max_extend=y_extend[1], y_extend[2])
    if(fancy_x == T) {
      p <- p + xlab("") + theme(axis.text.x = element_text(vjust=-0.5, color="black")) + 
        scale_x_discrete(labels = parameters[[strata]]$levels_fancy)
      } ; p
}

## Plot of iAUVC by genotype for standardized mixed-meal ****
plot_iAUC_geno.l <- lapply(c("glucose", "insulin"), function(m) {
  analysis %>% select(genotype, glucose_120iAUC.pos, insulin_120iAUC.pos) %>%
    pivot_longer(-"genotype", names_to="metab") %>%
    mutate_at("metab", ~gsub("_.*","",.)) %>%
    filter(metab == m) %>%
    group_by(genotype, metab) %>% filter(complete.cases(strata)) %>%
    reframe(n=n(), mean=mean(value), sd=sd(value)) %>% mutate(se=sd/sqrt(n)) %>%
    mutate_at("metab", ~factor(., levels=c("Glucose", "Insulin"))) %>%
    mutate_at("genotype", ~factor(., levels=c("HC genotype", "HF genotype"))) %>%
    ggplot(aes(x=genotype, y=mean, ymin=mean-se, ymax=mean+se, fill=genotype)) +
    facet_grid(cols=vars(metab)) +
    geom_bar(stat="identity") + geom_errorbar(width=0.075) +
    xlab(parameters$genotype$label) + ylab(paste0("Plasma ",m," mg/dL")) + 
    scale_fill_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    theme_bw() + 
    ggplot_ms + xlab("") + 
    scale_x_discrete(labels = parameters[[strata]]$levels_fancy) + 
    theme(axis.text.x = element_text(vjust=-0.5, color="black")) + 
    theme(strip.background = element_blank(), 
          strip.text = element_blank(),
          #axis.text.x = element_blank()
          ) + 
    scale_y_continuous(limits = c(0,3000), breaks = seq(0,3000,1000))
  })
  p

## P-values
summary(lm(glucose_120iAUC.pos ~ genotype+age+sex+PC1z+PC2z+PC3z, data = analysis)) # Ppair = 0.00666 ; Panova=0.085
anova(lm(insulin_120iAUC.pos ~ genotype+age+sex+PC1z+PC2z+PC3z, data = analysis)) # Ppair = 0.225 ; Panova=0.335

p %>% ggsave(filename="../output/fig_postprandial_mmtt_iauc_gene.pdf", width=6.5, height=3)

```

#### Self-Selected Meal Tolerance Test (Aim 2a)
Note: For all postprandial tests, times are relative to the start of the test day (i.e., 235 min = time 0 for the second test)

# Demographics, anthropometrics & fasting metabolites
**By meal selection**
```{r, echo=F, warning=F}
print_summary_table(
      analysis, vars_to_summarize = c(meal_choice="Meal Selection"), p_adjust = "none", 
      var_strata = "genotype", var_strata_order = c("HC genotype", "HF genotype"),
      p_types = "descriptive", p_smalln=T, factor_vars = "meal_choice") %>% kable()
rbind.data.frame(
      fread("../output/tab_descr_demographics_mealchoice.csv", header = T), 
      fread("../output/tab_descr_metabolites_mealchoice.csv", header = T)) %>% 
  #fwrite("../output/tab_descr_demogr_metab_mealchoice_print.csv")
  kable()

tapply(analysis$tg, analysis$meal_choice, mean_sd)
t.test(tg_log~meal_choice, data=analysis)
```

Notes: 
 - No demographic/descriptive differences between participants that chose either diet
 - Statistically (and clinically) significant differences in blood lipids between meal selection groups: log(Tg) & LDL higher in high-fat > high-carb diet selection

```{r, echo=F}
# Descriptive table (unadjusted)
rbind.data.frame(fread(paste0("../output/tab_descr_postprandial",unit,"_mealchoice.csv"), header = T) %>%
                   mutate(P_value=format_p_star(as.numeric(P_value))),
                 fread(paste0("../output/tab_descr_iAUC",unit,"_mealchoice.csv"), header = T) %>%
                   mutate(P_value=format_p_star(as.numeric(P_value)))) %>%
  kable()

```


#### Postprandial glucose & insulin, by meal selection

```{r, echo=F, fig.height=5, fig.width=10}
#ggarrange(plot_ppXtime_strat(metabolite = "glucose", times=c(235, 270, 300, 360), strata="meal_choice"), plot_ppXtime_strat(metabolite = "insulin", times=c(235, #270, 300, 360), strata="meal_choice"),
#          common.legend = T, legend = "right")
```

```{r, echo=F}
plot_glu_meal <- ggarrange(plot_ppXtime_stratified("glucose", times=c(235,270,300,360), strata = "meal_choice"), "", 
                           plot_iAUC_strat("glucose", strata = "meal_choice", iAUC=360, fancy_x = T),
                            nrow=1, widths=c(1.75, 0.1, 0.65), common.legend = T, legend = "top")

plot_insu_meal <- ggarrange(plot_ppXtime_stratified("insulin", times=c(235,270,300,360), strata = "meal_choice"), "", 
                            plot_iAUC_strat("insulin", strata = "meal_choice", iAUC=360, fancy_x = T),
                            nrow=1, widths=c(1.75, 0.1, 0.65), common.legend = T, legend = "none")

ggarrange(plot_glu_meal, plot_insu_meal, nrow=2, common.legend = T, heights=c(0.95, 0.95), align="hv") %>%
    ggsave(filenam="../output/fig_multipanel_ss_mealtype_summary_v3.pdf", height=6,width=10)

## postprandial response curves, only
p_glu_meal_indiv <- plot_ppXtime_stratified("glucose", times=c(235,270,300,360), strata = "meal_choice")
p_insu_meal_indiv <- plot_ppXtime_stratified("insulin", times=c(235,270,300,360), strata = "meal_choice")
ggarrange("", p_glu_meal_indiv, "", p_insu_meal_indiv, common.legend = T, legend = "bottom",
          nrow=1, widths=c(0.05,1,0.05,1), labels=c("", "A", "", "B"), hjust=0.75, vjust=1.35, font.label = c(size=16)) %>%
  ggsave(filename="../output/fig_postprandial_standard_meal_v2.pdf", height=3,width=7)

```


##### Meal selection by genotype 
```{r, echo=F, warning=F, fig.width=6, fig.height=2}
meal_choice.pal <- c(palettes$NatExt$Oranges[2], palettes$NatExt$Greens[2])
p <- analysis %>% group_by(genotype) %>%
  filter(complete.cases(genotype, meal_choice)) %>%
  count(genotype, meal_choice) %>%
  mutate(geneXmeal = paste0(genotype, " & ", meal_choice)) %>%
  ggplot(aes(x=genotype, y=n, fill=geneXmeal)) +
  geom_bar(stat="identity", position="dodge") + 
  scale_fill_manual(values=parameters$gene_x_meal$palette, name="Meal Choice") + 
  theme_bw()+theme(axis.text.x=element_text(color = "black", face="bold")) + 
  ylab("Frequency") + xlab("Genetic Category")
ggplot_extend_ylim(p, y_max_extend = 0.1)


#ggplot_extend_ylim(p, y_max_extend = 0.1) %>% ggsave(filename="../output/fig_mealchoice_geno_color.pdf", height=4, width=6)
```

Note: This is **inverse** of expected: Participants who genetically "Prefer Carbs" tended to choose the High Fat meal, while those that genetically "Prefer Fat" tended to choose the High Carb meal

```{r}
# Regression (metabolite ~ meal choice + basic covariates) 
fread("../output/tab_result_postprandial_selected_mealonly_mgdL.csv") %>%
  select(Model, Outcome, Effect, Exposure, Beta.SE, P=P_signif, Anova.P=anovaP_signif)

## p-values for baseline (time 0) glucsoe and insulin
summary(lm(glucose ~ genotype+age+sex+PC1z+PC2z+PC3z, data=analysis)) # 0.7177
summary(lm(insulin ~ genotype+age+sex+PC1z+PC2z+PC3z, data=analysis)) #0.9803
 
```
 

#### *Self-Selected Meals (High Carb vs. High Fat)*

#### Postprandial glucose & insulin, by genetic category & meal selection
```{r, echo=F, fig.height=8, fig.width=12}
plot_glu_geneXmeal <- ggarrange(plot_ppXtime_stratified_sum("glucose", times=c(235,270,300,360), strata="gene_x_meal"), "",
                                plot_iAUC_strat("glucose", iAUC=360, strata="gene_x_meal"), align="h",
                                nrow=1, widths=c(1.75, 0.01, 0.75), common.legend = T, legend = "none")
plot_insu_geneXmeal <- ggarrange(plot_ppXtime_stratified_sum("insulin", times=c(235,270,300,360), strata="gene_x_meal"), "",
                                plot_iAUC_strat("insulin", iAUC=360, strata="gene_x_meal"),  align="h",
                                nrow=1, widths=c(1.75, 0.01, 0.75), common.legend = T, legend = "bottom")
ggarrange(plot_glu_geneXmeal, plot_insu_geneXmeal, nrow=2, legend = "bottom", heights=c(1, 1.15)) 


## Version for PNF/ADA poster
ggarrange(plot_glu_geneXmeal, plot_insu_geneXmeal, nrow=2, legend = "bottom", heights=c(1, 1.15)) %>%
  ggsave(filename="../output/fig_postprandial_ssmt_pct_genexmeal.pdf", height=6,width=8)

ggarrange(p_horiz, ggarrange(plot_glu_geneXmeal, plot_insu_geneXmeal, nrow=2, legend = "bottom", heights=c(1, 1)),
          nrow=2, heights=c(0.25,1), align="h") %>%
  ggsave(filename="../output/fig_postprandial_ssmt_pct_genexmeal.pdf", height=7,width=8)

```

```{r, echo=F, fig.height=8, fig.width=10}

## Horizontal stacked bar graph ----------------
p_horiz <- analysis %>% group_by(genotype) %>%
  filter(complete.cases(genotype, meal_choice)) %>%
  count(genotype, meal_choice) %>%
  mutate(geneXmeal = paste0(genotype, " & ", meal_choice)) %>%
  mutate(pct = ifelse(genotype=="HC genotype", n/12, n/10)*100) %>%
  mutate_at("geneXmeal", ~factor(., levels=c("HC genotype & HF meal", "HC genotype & HC meal", 
                                             "HF genotype & HF meal","HF genotype & HC meal"))) %>%
  ggplot(aes(x=genotype, y=pct, fill=geneXmeal)) +
  geom_bar(stat="identity", position=position_stack()) +
  scale_fill_manual(values=parameters$gene_x_meal$palette[c(2,1,4,3)], name="Genotype x Meal choice") + 
  theme_bw()+theme(axis.text.x=element_text(color = "black", face="bold", size=10),
                   axis.text.y = element_text(color="black")) + 
  theme(legend.key.size = unit(0.4, "cm"),
        legend.title = element_text(size=10)) +
  ylab("Percent") + xlab("") + 
  coord_flip() + 
  guides(fill = guide_legend(reverse = F)) ; p_horiz


## Postprandial responses by meal type, only (not considering genotype effect)
plot_ppXtime_stratified(metabolite="glucose", times=c(235,270,300,360), strata="meal_choice", data=analysis)
plot_ppXtime_stratified(metabolite="insulin", times=c(235,270,300,360), strata="meal_choice", data=analysis)

summary(lmerTest::lmer(glucose~meal_choice*time+age+sex+(1|id)+PC1z+PC2z+PC3z, data=postprandial %>% filter(time %in% c(235,270,300,360))))
summary(lmerTest::lmer(glucose~time*meal_choice+age+sex+(1|id), data=postprandial %>% filter(time %in% c(235,270,300,360))))

anova(lmerTest::lmer(insulin~time*meal_choice+age+sex+(1|id), data=postprandial %>% filter(time %in% c(235,270,300,360))))

## Stratified, summary only --------------------------
plot_ppXtime_stratified_sum_panel <- function(metabolite, times = c(235,270,300,360), panel="meal_choice", 
                                       strata="genotype", data=analysis, spaghetti=T) {
  strata_var=parameters[[strata]]$strata 
  #y_label=paste(str_to_sentence(metabolite), Unit, " mean \u00B1 SE")
  y_label=paste0("Plasma ", metabolite, ", ", Unit)
  data %>% select(id, starts_with(metabolite), strata=all_of(strata_var), panel=all_of(panel)) %>%
    rename_with(~gsub(metabolite, "x", .), starts_with(metabolite)) %>%
    rename_with(., ~gsub("m", "", gsub("_log", "", .))) %>%
    select(id, strata, paste0("x_", times), panel) %>%
    pivot_longer(-c(id, strata, panel), names_sep="_", names_to=c("metabolite", "time")) %>%
    mutate(across(c("time", "value"), ~as.numeric(.))) %>%
    group_by(strata, panel, time) %>% 
    
    #Convert to mg/dL**
    #mutate(value=value*18) %>%
    
    reframe(n=n(), mean=mean(value, na.rm=T), sd=sd(value, na.rm=T)) %>%
    mutate(se=sd/sqrt(n)) %>% filter(!is.na(strata)) %>%

    ggplot(aes(x=time, y=mean, ymin=mean-se, ymax=mean+se, group=strata, color=strata)) + 
    scale_x_continuous(breaks = times, labels = c(0,35,65,125)) + 
    facet_grid(cols=vars(panel)) +   #geom_vline(xintercept = times[1], color="grey25", linewidth=1.35) +
    geom_line(alpha=0.85, position=position_dodge(5.5), linewidth=0.75) + 
    geom_point(size=1.75, position=position_dodge(5.5)) +
    geom_errorbar(width=5, linewidth=0.75, alpha=0.85, position=position_dodge(5.5)) +
    scale_color_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    scale_y_continuous(expand=c(0.1,0.05)) +
    xlab("Time (minutes)") + ylab(y_label) + 
    theme_bw() + ggplot_ms + 
    theme(strip.background = element_blank(), strip.text = element_text(face="bold"))
}
    
plot_geneXmeal <- ggarrange(
  plot_ppXtime_stratified_sum_panel("glucose", times=c(235,270,300,360), strata="genotype") +
    theme(axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank()), "",
  plot_ppXtime_stratified_sum_panel("insulin", times=c(235,270,300,360), strata="genotype") +
    theme(strip.text.x = element_blank()),
  align="hv", nrow=3, common.legend = T, legend = "none", widths = c(1.15,1), heights=c(1.15,-0.1,1))
plot_geneXmeal

pAB <- ggarrange(p_horiz, plot_geneXmeal, nrow=2, legend = "right", heights=c(0.25, 1), align="h") 

```


```{r, echo=F}
results_selected <- rbind.data.frame(
  fread("../output/tab_result_postprandial_selected_allmodels_bymeal_HFref_mgdL.csv"),
  fread("../output/tab_result_postprandial_selected_allmodels_bygeno_HFref_mgdL.csv")) %>%
  dplyr::select(Meal.Type, Strata, Level, Model, Outcome, Effect, Exposure, Beta.SE, P=P_signif, Anova.P=anovaP_signif)
```

#### Effect of genetic category on **postprandial** glucose & insulin responses to a self-selected meal

# Model(s):** Main & interaction effects LME model
```{r}
results_selected %>% 
  filter(Strata=="Meal Choice") %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  filter(Model == "primary") %>%
  arrange(Level) %>%
  dplyr::select(-Strata, -Model) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  #fwrite("../output/tab_result_lme_glycemic_selected_postprandial_bymeal_HFref_print.csv") 
  kable(caption="Stratified by Meal Choice, model adjusting for time0, postprandial glycemic traits")

## p-values for baseline (time 0) glucsoe and insulin
t.test(tg_235 ~ meal_choice, data=analysis) ; tapply(analysis$tg_235, analysis$meal_choice, mean_sd)
t.test(ldl_235 ~ meal_choice, data=analysis) ; tapply(analysis$ldl_235, analysis$meal_choice, mean_sd)
summary(lm(tg_235 ~ meal_choice+age+sex+PC1z+PC2z+PC3z+bmi, data=analysis)) # 0.64333 
summary(lm(ldl_235 ~ meal_choice+age+sex+PC1z+PC2z+PC3z+bmi, data=analysis)) # 0.64333 

```

**Meal choice effect, for different genotypes, on postprandial responses to self-selected meal (stratified by genetic category)**
```{r}
results_selected %>% 
  filter(Strata=="Genotype") %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  filter(Model == "primary") %>%
  arrange(Level) %>%
  select(-Strata, -Model) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  #fwrite("../output/tab_result_lme_glycemic_selected_postprandial_bygeno_print.csv") 
  kable(caption="Stratified by Meal Choice, model adjusting for time0, postprandial glycemic traits")
```

#### Effect of genetic category on **iAUC** glucose & insulin responses to a self-selected meal

**Model(s):** lm(metabolite_iAUC~genetic_category+age+sex+PC1+PC2+PC3+meal_choice+[metabolite_235], data=analysis)
```{r}
fread(paste0("../output/tab_result_lm_glycemic_selected_iAUC_allModels_v3.csv")) %>%
  mutate(Metabolite=str_to_sentence(gsub("[_].*", "", Outcome))) %>% 
  mutate(Outcome=gsub(".*[_]", "", gsub("iAUC.*", "min iAUC", Outcome))) %>%
  filter(Strata=="Meal Choice") %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  filter(Model != "AdjTime0") %>%
  arrange(Level) %>%
  select(Model, Level, N, Metabolite, Outcome, Exposure, Beta.SE, P=P_signif, AnovaP=anovaP_signif) %>%
  mutate_all(., ~ifelse(is.na(.)==T | .=="NA (NA, NA)", "-", .)) %>%
  kable()
```

```{r}
fread(paste0("../output/tab_result_lm_glycemic_selected_iAUC_allModels_v3.csv")) %>%
  mutate(Metabolite=str_to_sentence(gsub("[_].*", "", Outcome))) %>% 
  mutate(Outcome=gsub(".*[_]", "", gsub("iAUC.*", "min iAUC", Outcome))) %>%
  filter(Strata=="Genetic Category") %>%
  filter(!startsWith(Exposure, "Time"), !startsWith(Exposure, "Glucose"), !startsWith(Exposure, "Insulin")) %>%
  filter(Model == "AdjTime0") %>%
  arrange(Strata) %>%
  select(Model, Level, N, Metabolite, Outcome, Exposure, Beta.SE, P=P_signif, AnovaP=anovaP_signif) %>%
  #fwrite("../output/tab_result_120iauc_selected_bygeno_print.csv")
  kable()
```

## Sensitivity Analyses
## Postprandial responses by genotype for ALL TIME POINTS
```{r}
# Genotype, only
p_glu_geno_indiv_6hr <- plot_ppXtime_strat_spaghetti_summary("glucose", times = c(0,30,60,120,180,235,270,300,360))
p_insu_geno_indiv_6hr <- plot_ppXtime_strat_spaghetti_summary("insulin", times = c(0,30,60,120,180,235,270,300,360))
ggarrange(p_glu_geno_indiv_6hr, p_insu_geno_indiv_6hr, common.legend = T, legend = "bottom", nrow=2, align="v") %>%
  ggsave(filename="../output/fig_postprandial_6hr_genotype.pdf", height=6,width=10)

# Meal choice, only
p_glu_meal_indiv_6hr <- plot_ppXtime_strat_spaghetti_summary("glucose", times = c(0,30,60,120,180,235,270,300,360), strata="meal_choice")
p_insu_meal_indiv_6hr <- plot_ppXtime_strat_spaghetti_summary("insulin", times = c(0,30,60,120,180,235,270,300,360), strata="meal_choice")
ggarrange(p_glu_meal_indiv_6hr, p_insu_meal_indiv_6hr, common.legend = T, legend = "bottom", nrow=2, align="v") %>%
  ggsave(filename="../output/fig_postprandial_6hr_meal.pdf", height=6,width=10)

# Genotype x Meal choice
p_glu_genoxmeal_indiv_6hr <- plot_ppXtime_strat_spaghetti_summary("glucose", times = c(0,30,60,120,180,235,270,300,360), strata="gene_x_meal")
p_insu_genoxmeal_indiv_6hr <- plot_ppXtime_strat_spaghetti_summary("insulin", times = c(0,30,60,120,180,235,270,300,360), strata="gene_x_meal")
ggarrange(p_glu_genoxmeal_indiv_6hr, p_insu_genoxmeal_indiv_6hr, common.legend = T, legend = "bottom", nrow=2, align="v") %>%
  ggsave(filename="../output/fig_postprandial_6hr_genotypexmeal.pdf", height=6,width=10)
```



## Metabolomics 

Basic plotting functions for metabolomics data
```{r}
# ==============================================================================
## Plot mean metabolomics by time with individual-level lines and error bars 
# ==============================================================================
plot_metabXtime <- function(metabolites, times = c(0,120,235), strata="genotype", 
                            data=analysis2, p_value=F) {
  strata_var=parameters[[strata]]$strata 
  y_label <- met_info$Name[met_info$HMDB %in% metabolites] ; names(y_label) <- metabolites
  
  if(length(metabolites)>1) {
    dat <- data %>% select(id, c(as.vector(metabolites)), strata=all_of(strata_var), time) %>%
      pivot_longer(all_of(metabolites), names_to="metabolites") %>%
      #rename_with(~gsub(metabolite, "value", .), starts_with(metabolite)) %>%
      filter(time %in% times) %>%
      mutate_at("time", ~as.numeric(case_when(.=="0"~0, .=="120"~120, .=="235"~235, .=="360"~360))) %>%
      group_by(strata, time, metabolites) %>% 
      filter(is.na(strata)==F)
    
  } else if(length(metabolites) == 1) {
    
    dat <- data %>% select(id, c(as.vector(metabolites)), strata=all_of(strata_var), time) %>%
      rename_with(., ~gsub(metabolites, "value", .)) %>%
      filter(time %in% times) %>%
      mutate_at("time", ~as.numeric(case_when(.=="0"~0, .=="120"~120, .=="235"~235))) %>%
      group_by(strata, time) %>% 
      filter(is.na(strata)==F) %>%
      mutate(metabolites=metabolites)
    }
  
  dat.summary <- dat %>% 
    reframe(n=n(), mean=mean(value, na.rm=T), sd=sd(value, na.rm=T)) %>%
    mutate(se=sd/sqrt(n)) %>% filter(!is.na(strata))
  
  dat %>% 
    ggplot(aes(x=time, y=value, group=id, color=strata)) + 
    facet_grid(~metabolites, labeller = as_labeller(y_label)) +
    scale_x_continuous(breaks=times) +
    #geom_vline(xintercept = times[1], color="grey25", linewidth=1) +
    geom_line(alpha=0.55, linewidth=0.25) + 
    #geom_point(size=2.5, position=position_dodge(5.5)) +
    stat_summary(aes(group = strata), geom = "point", fun = mean, size = 2) + 
    stat_summary(aes(group = strata), geom = "line", fun = mean, linewidth = 1) +
    #stat_summary(aes(group = strata), geom = "line", fun = mean, linewidth = 1) +
    geom_errorbar(data=dat.summary, aes(x=time, y=mean, ymin=mean-se, ymax=mean+se, 
                                        color=strata, group=strata), inherit.aes = F, #position=position_dodge(8),
                  width=5, linewidth=0.75, alpha=0.75) +
    scale_color_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    scale_y_continuous(expand=c(0.1,0.05)) + ylab("Mean (SE) concentration") +
    xlab("Time (minutes)") + 
    theme_bw() + 
    theme(panel.grid = element_line(linewidth=0.25),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.background = element_rect(linewidth = 0.35, color="black"),
          legend.margin = margin(0.1,0.1,0.1,0.1,unit="cm"),
          legend.title = element_text(face="bold"),
          legend.text = element_text(size=10),
          strip.background = element_blank(),
          strip.text=element_text(face="bold")) 
}

# ================================================================
## Volcano plots for metabolomics: for log-transformed betas
# ================================================================
plot_volcano.fun <- function(data, p_eff=23, beta_threshold=0.5, title="", add_labels=T, col_unique=F, metab_unique=F, 
                             col1=palettes$NatExt$Greens[3], col2=palettes$NatExt$Purples[3], colUnq=col2) {
  ## If "unique" metabolites should be colored differently:
  fill_unq <- function(x) scale_color_manual(values=c("A"=col1, "B"=col2, "C"="lightgrey"), 
                       labels=c(A=paste0("P <0.05/", p_eff, " & log2 fold change >",beta_threshold),
                                B=paste0("log2 fold change >",beta_threshold), 
                                C="P>0.05/0.3 & log2 fold change <0.3"), name="") 
  p <- data %>% 
    mutate(across(c(beta, se, p), ~as.numeric(.))) %>%
    #mutate(beta_std = beta/se) %>%
    #mutate(strength = ifelse(p<.05/p_eff, "sig", "ns")) %>%
    #mutate(dir = ifelse(abs(beta) > beta_threshold, "effect", "")) %>%
    mutate(col = ifelse(p<0.05/p_eff & abs(beta) > beta_threshold, "A", 
                                 ifelse(p>=0.05/p_eff & abs(beta) > beta_threshold, "B", "C"))) %>%
    mutate(col = ifelse(col_unique==T & col=="A" & Outcome %in% metab_unique, "D", col)) %>%
    #mutate(Lab = ifelse(p <0.05/p_eff, Outcome, NA)) %>%
    ggplot(aes(x=beta, y=-log10(p), color=col)) +  
    facet_grid(~Time) +
    geom_point(size=2, alpha=0.75) + 
    scale_color_manual(values=c("A"=col1, "B"=col2, "C"="lightgrey", "D"=colUnq), 
                       labels=c(A=paste0("P <0.05/", p_eff, " & log2 fold change >",beta_threshold),
                                B=paste0("log2 fold change >",beta_threshold), 
                                C="P>0.05/0.3 & log2 fold change <0.3"), name="") + 
    theme_bw() + xlab("Beta coefficient for HC vs HF (ref) genotype \n of log2 fold change from 0 min") +
    geom_hline(yintercept = -log10(.05/p_eff), linetype="dashed") + 
    #geom_hline(yintercept = -log10(.05), linetype="dashed", linewidth=0.35) +
    geom_vline(xintercept = c(-beta_threshold, beta_threshold), linetype="dashed") + 
    ggtitle(title) + ggplot_ms + 
    theme(legend.key.size = unit(0.5, "cm")) + 
    theme(#legend.text = element_text(size=8),
          strip.background = element_blank(),
          legend.title = element_blank(),
          strip.text = element_text(face="bold"),
          axis.title.x = element_text(size=8)) +
    theme(panel.grid.minor.x = element_line(linewidth=0.25))
  
  # Add labels
  if(add_labels==T) {
    #p <- p + geom_label(aes(label=Lab), nudge_y=0.05, size=2, color="black", fill=NA, label.size = 0)
    p <- p + geom_label_repel(aes(label=Lab), label.padding = 0.05, box.padding = 0.05, nudge_y = 0.1,
                              size=2, color="black", fill=NA, label.size = 0, max.overlaps = 20)
  } ; p
}

```


Summary of metabolite changes by time: postprandial metabolites
```{r}
# ========================================================
# Volcano for metabolite changes over time - TOTAL (v1)
# ========================================================

lme_metab_mmtt_timeonly <- fread("../data/processed/tab_result_lme_metab_mmtt_timeonly.csv") 

res_metab_mmtt_timeonly <- lme_metab_mmtt_timeonly %>% 
  mutate(fc=exp(beta), log2fc=beta/log(2)) %>%
  filter(Exposure != "Time_(joint)") %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub("Time_", "", .), " min")) 

plot_volcano.fun(res_metab_mmtt_timeonly, add_labels = F, beta_threshold = 0.25) %>%
  ggsave(filename="../output/fig_metab_volcano_timeonly_2.pdf", height=5, width=10)

## Summary of significant metabolites
res_metab_mmtt_timeonly %>% filter(p<0.05) %>% pull(Outcome) %>% unique() %>% length() # 396
lme_metab_mmtt_timeonly %>% filter(anovaP<0.05) %>% pull(Outcome) %>% unique() %>% length() #366

res_metab_mmtt_timeonly %>% filter(p<0.05/23) %>% pull(Outcome) %>% unique() %>% length() #307
res_metab_mmtt_timeonly %>% filter(p<0.05/23) %>% pull(outcome) %>% as.data.frame() %>% fwrite("../data/processed/enrichment/metab_postpran_all.txt")

## Metabolites/pathways
metab.pp <- res_metab_mmtt_timeonly %>% filter(p<0.05/23) %>% pull(outcome) %>% unique()
#Biosynthesis of unsaturated fatty acids:
unsatfat <- c("Palmitic acid", "Stearic acid", "Arachidic acid", "Oleic acid", "Linoleic acid", 
              "Arachidonic acid", "Dihomo-gamma-linolenic acid", "gamma-Linolenic acid", 
              "Docosahexaenoic acid", "Eicosapentaenoic acid", "alpha-Linolenic acid")
res_metab_mmtt_timeonly %>% filter(Outcome %in% unsatfat) %>% arrange(p)
metab_dict %>% filter(Standardized.name %in% unsatfat)

```

### Summary of metabolites changing by time, STRATIFIED by genotype
```{r}
lme_metab_mmtt_time_bygeno <- fread("../data/processed/tab_result_lme_metab_mmtt_unadj_bygeno.csv")

res_metab_mmtt_time_bygeno <- lme_metab_mmtt_time_bygeno %>% 
  mutate(beta=beta/log(2)) %>%
  filter(Exposure != "Time_(joint)") %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub("Time_", "", .), " min")) %>%
  mutate_at("Time", ~factor(., levels=c("120 min", "235 min")))

## Metabolite Lists
metabs.hc120 <- fread("../data/processed/enrichment/metab_pEff_log2fc05/hc120_pEff_log2fc05.txt", col.names = "V1") %>% pull(V1) ; length(metabs.hc120) #142
metabs.hc235 <- fread("../data/processed/enrichment/metab_pEff_log2fc05/hc235_pEff_log2fc05.txt", col.names = "V1") %>% pull(V1) ; length(metabs.hc235) #131
metabs.hf120 <- fread("../data/processed/enrichment/metab_pEff_log2fc05/hf120_pEff_log2fc05.txt", col.names = "V1") %>% pull(V1) ; length(metabs.hf120) #111
metabs.hf235 <- fread("../data/processed/enrichment/metab_pEff_log2fc05/hf235_pEff_log2fc05.txt", col.names = "V1") %>% pull(V1) ; length(metabs.hf235) #117

## Counting UNIQUE metabolites in each group for MS
metabs.hc120[!metabs.hc120 %in% metabs.hf120] %>% length() # 38 unique metabolites for HC/120
metabs.hf120[!metabs.hf120 %in% metabs.hc120] %>% length() # 7 unique metabolites for HC/120
metabs.hc235[!metabs.hc235 %in% metabs.hf235] %>% length() # 40 unique metabolites for HC/120
metabs.hf235[!metabs.hf235 %in% metabs.hc235] %>% length() # 26 unique metabolites for HC/120

## Intersection at each time point (metabolites chaning in BOTH genotypes)
metabs.all120 <- (res_metab_mmtt_timeonly %>% filter(outcome %in% c(intersect(metabs.hc120, metabs.hf120))) %>%
  arrange(p) %>% pull(outcome))[1:20] 
metabs.all235 <- (res_metab_mmtt_timeonly %>% filter(outcome %in% c(intersect(metabs.hc235, metabs.hf235))) %>%
  arrange(p) %>% pull(Outcome))

## Metabolite Labels - SORT by STRENGTH
metabs.hc120.lab <- metabs.hc120[!metabs.hc120 %in% metabs.hf120][1:20] ; metabs.hc235.lab <- metabs.hc235[!metabs.hc235 %in% metabs.hf235][1:20]
metabs.hf120.lab <- metabs.hf120[!metabs.hf120 %in% metabs.hc120][1:20] ; metabs.hf235.lab <- metabs.hf235[!metabs.hf235 %in% metabs.hc235][1:20]


# All participants
p_v.all <- plot_volcano.fun(
  res_metab_mmtt_timeonly %>% mutate(beta=beta/log(2)) %>%
    mutate(Lab = ifelse(Time == "120 min" & outcome %in% metabs.all120, gsub(" &.*", "", Outcome), 
                        ifelse(Time == "235 min" & outcome %in% metabs.all235, gsub(" &.*", "", Outcome), NA))),
   # mutate(Lab2 = ifelse(Outcome %in% metabolites_geno.labs, Outcome, NA)),
  add_labels = T, col1="#00000098", col2="#7F7F7F95", beta_threshold = 0.5) +
  facet_grid(cols=vars(Time)) + 
  theme(axis.title.x = element_blank(), 
        plot.margin = margin(c(0,0,-0.1,0), unit="mm"),
        axis.text.x = element_blank(),
        axis.title.y = element_text(size=8),
        axis.ticks.x = element_blank(),
        #strip.text = element_blank()
        ) +  
  #geom_label_repel(aes(label=Lab2), label.padding = 0.05, box.padding = 0.05, nudge_y = 0.1, size=2, color="black", fontface="bold", fill=NA, label.size = 0, max.overlaps = 10) +
  geom_text(data = data.frame(label="All participants (N = 22)", x=-8.35, y=20.65), aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
  coord_cartesian(ylim=c(0,20), xlim=c(-8,10)) ; p_v.all
  
# HC genotype
p_v.hc <- plot_volcano.fun(
  res_metab_mmtt_time_bygeno %>% #mutate(beta=beta/log(2)) %>% 
      mutate(Lab = ifelse(Time == "120 min" & outcome %in% metabs.hc120.lab, gsub(" &.*", "", Outcome), 
                          ifelse(Time == "235 min" & outcome %in% metabs.hc235.lab,
                                                        gsub(" &.*", "", Outcome), NA))) %>% 
    #mutate(Lab2 = ifelse(Outcome %in% metabolites_geno.labs, Outcome, NA)) %>%
    filter(genotype=="HC genotype"), add_labels = T,
  col1=parameters$genotype$palette[[2]], col2=parameters$gene_x_meal$palette[2], #col1="#00000080", col2="#7F7F7F95",
  #col_unique = T, metab_unique = c(metabs.hc120, metabs.hc235), colUnq = "#E97132") +
  beta_threshold = 0.5) +
  facet_grid(cols=vars(Time)) + 
  theme(#plot.margin = margin(0.1,0.1,-0.1,0.1, unit="cm"),
        plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.y = element_text(size=8), #axis.ticks.y = element_blank(), #axis.text.y = element_blank(),
        strip.text = element_blank()
        ) + 
  geom_text(data = data.frame(label="HC genotype (N = 12)", x=-8.35, y=12.35), aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
  #geom_label_repel(aes(label=Lab2), label.padding = 0.05, box.padding = 0.05, nudge_y = 0.1, size=2, color="black", fontface="bold", fill=NA, label.size = 0, max.overlaps = 10) +
  coord_cartesian(ylim=c(0,12), xlim=c(-8,8)) + 
  scale_y_continuous(breaks=seq(0,12,4)) + scale_x_continuous(breaks=seq(-8,10,4)); p_v.hc


# HF genotype
p_v.hf <- plot_volcano.fun(
  res_metab_mmtt_time_bygeno %>% mutate(beta=beta/log(2)) %>% 
    mutate(Lab = ifelse(Time == "120 min" & outcome %in% metabs.hf120.lab, gsub(" &.*", "", Outcome), 
                        ifelse(Time == "235 min" & outcome %in% metabs.hf235.lab, gsub(" &.*", "", Outcome), NA))) %>% 
    #mutate(Lab2 = ifelse(Outcome %in% metabolites_geno.labs, Outcome, NA)) %>%
    filter(genotype=="HF genotype"), 
  col1=parameters$genotype$palette[[1]], col2=parameters$gene_x_meal$palette[3], #
  beta_threshold = 0.5, add_labels = T, col_unique = T, metab_unique = c(metabs.hf120, metabs.hf235), colUnq = "#156082") +
  facet_grid(cols=vars(Time)) + 
  xlab("log<sub>2</sub> fold change from 0 min") + 
  theme(#plot.margin = margin(0.1,0.1,-0.1,0.1, unit="cm"),
        plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_markdown(size=8),
        #axis.title.x = element_blank(), #axis.text.x = element_blank(),
        #axis.title.y = element_blank(), 
        axis.title.y = element_text(size=8), #axis.ticks.y = element_blank()) +
        strip.text = element_blank()
  ) +
  #geom_label_repel(aes(label=Lab2), label.padding = 0.05, box.padding = 0.05, nudge_y = 0.1, size=2, color="black", fontface="bold", fill=NA, label.size = 0, max.overlaps = 10) +
  geom_text(data = data.frame(label="HF genotype (N = 10)", x=-8.35, y=12.35), aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
  coord_cartesian(ylim=c(0,12), xlim=c(-8,8)) +
  scale_y_continuous(breaks=seq(0,12,4)) + 
  scale_x_continuous(breaks=seq(-8,10,4)); p_v.hf

#ggarrange(p_v.all, p_v.hc, p_v.hf, nrow=3, common.legend = T, legend = "none", heights=c(1,1,1.25)) %>%
#  ggsave(filename="../output/fig_metab_volcano_bygeno_panel_v1.pdf", width=8, height=10)

## Horizontal
#ggarrange(p_v.all,"", p_v.hc, "", p_v.hf, nrow=1, common.legend = T, legend = "none", widths=c(1.05,0.05,0.95,0.05,1)) %>%
 # ggsave(filename="../output/fig_metab_volcano_bygeno_panel_labelsUnq.pdf", width=10, height=4.5)

## Vertical
plot_volc_mmtt <- ggarrange(p_v.all, p_v.hc, p_v.hf, ncol=1, common.legend = F, legend = "none", heights=c(1.1,0.9,1.)) %>%
  ggsave(filename="../output/fig_metab_volcano_bygeno_panel_labelsUnq_top20.pdf", width=6, height=7.5)
```


```{r}
## Compile supplementary table with metabolite changes in All, HC, HF subsets
tab_metab_summary <- rbind.data.frame(
  res_metab_mmtt_timeonly %>% select(HMDB = outcome, Compound.ID = Outcome, Time, Beta=beta, se, lowCI, upCI, p, P.anova=anovaP) %>%
    mutate_at(c("Beta", "lowCI", "upCI"), ~exp(.)) %>% mutate(P.pairwise=p) %>%
    mutate_at(c("P.pairwise", "P.anova"), ~ifelse(.<0.05/23, paste0(format_p(.), "**"), 
                                                  ifelse(.>0.05/23 & .<0.05, paste0(format_p(.), "*"), round(.,3)))) %>%
    mutate(Beta.SE = sprintf("%s (%s)", round(Beta,2), round(se,2))) %>%
    mutate(Beta.95CI = sprintf("%s (%s, %s)", round(Beta,2), round(lowCI,2), round(upCI,2))) %>%
    mutate(Set = "All", .before=HMDB) %>% 
    select(Set, HMDB, Compound.ID, Time, Beta.SE, P.pairwise, P.anova, p),
  res_metab_mmtt_time_bygeno %>% select(Set=genotype, HMDB = outcome, Compound.ID = Outcome, Time, Beta=beta, se, lowCI, upCI, p, P.anova=anovaP) %>%
    mutate(Set=gsub(" genotype", "", Set)) %>%
    mutate_at(c("Beta", "lowCI", "upCI"), ~exp(.)) %>% mutate(P.pairwise=p) %>%
    mutate_at(c("P.pairwise", "P.anova"), ~ifelse(.<0.05/23, paste0(format_p(.), "**"), 
                                                  ifelse(.>0.05/23 & .<0.05, paste0(format_p(.), "*"), round(.,3)))) %>%
    mutate(Beta.SE = sprintf("%s (%s)", round(Beta,2), round(se,2))) %>%
    mutate(Beta.95CI = sprintf("%s (%s, %s)", round(Beta,2), round(lowCI,2), round(upCI,2))) %>%
    select(Set, HMDB, Compound.ID, Time, Beta.SE, P.pairwise, P.anova, p)
  ) %>%
  pivot_wider(id_cols =c(HMDB, Compound.ID, Time), names_from=Set, values_from=c(Beta.SE, p, P.pairwise, P.anova)) %>%
  mutate(Signif.Sets = ifelse(
    p_All <0.05/23 & p_HC <0.05/23 & p_HF <0.05/23,  "All participants",
    ifelse(p_HC <0.05/23 & p_HF >0.05/23, "HC genotype, only", 
           ifelse(p_HC >0.05/23 & p_HF <0.05/23, "HF genotype, only", "-")))) %>%
  select(-c("p_All", "p_HC", "p_HF")) %>%
  select(HMDB, Compound.ID, Time, ends_with("All"), ends_with("HC"), ends_with("HF"), Signif.Sets)

# Summarize
tab_metab_summary %>% fwrite("../output/tab_metab_summary_lme_allgeno.csv")
```


## Unique pathways represented by HC/HF genotype
```{r}
# ====================================================================
## Descriptive enrichment plots 
# ====================================================================

# P <0.05/23 && B >0.05 -------------------
metab_sets <- rbind.data.frame(
  #fread("../data/metaboanalyst/oea/oea_peff_b05/oea_hc120/msea_ora_result.csv") %>% mutate(set="HC genotype @ 120 min"),
  fread("../data/metaboanalyst/oea/oea_pEff_log2fc05/hc120/msea_ora_result.csv") %>% mutate(set="HC genotype @ 120 min"),
  fread("../data/metaboanalyst/oea/oea_pEff_log2fc05/hc235/msea_ora_result.csv") %>% mutate(set="HC genotype @ 235 min"),
  fread("../data/metaboanalyst/oea/oea_pEff_log2fc05/hf120/msea_ora_result.csv") %>% mutate(set="HF genotype @ 120 min"),
  fread("../data/metaboanalyst/oea/oea_pEff_log2fc05/hf235/msea_ora_result.csv") %>% mutate(set="HF genotype @ 235 min")
  ) %>% rename(p="Raw p") %>%
  mutate(log10p=-log10(p)) %>%
  mutate(Metabolite.Set = factor(V1, levels = rev(unique(V1[order(p)])))) %>%
  mutate(genotype = gsub("[@].*", "", set),
        time = gsub(".*[@] ", "", set)
        ) ; metab_sets

## Filter for only the top 10 pathways
to_plot <- c("Biosynthesis of unsaturated fatty acids", "Arachidonic acid metabolism", "Fatty acid metabolism", "Primary bile acid biosynthesis",
             "Fatty acid elongation", "Fatty acid degradation", "Linoleic acid metabolism", "alpha-Linolenic acid metabolism",
             "Taurine and hypotaurine metabolism", "Arginine and proline metabolism", "Arginine and proline metabolism",
             "Fructose and mannose metabolism", "Cysteine and methionine metabolism", "Tryptophan metabolism",
             "Valine, leucine and isoleucine biosynthesis")

plot_enrich_mmtt <- metab_sets %>% 
  select(V1, log10p, Metabolite.Set, genotype, time) %>%
  filter(V1 %in% to_plot) %>%
  ggplot(aes(x=log10p, y=Metabolite.Set, fill = genotype, group = genotype)) + 
  facet_grid(~time) + 
  theme_bw() + ggplot_ms + 
  geom_vline(xintercept = 0, linewidth=0.15, color="black") +
  geom_col(position = position_dodge(), width=0.75) + 
  scale_fill_manual(values=c("HC genotype "= parameters$genotype$palette[[2]], 
                             "HF genotype "= parameters$genotype$palette[[1]]),
                    name="Genotype") + 
  geom_vline(xintercept = -log10(.05), linetype="dashed", linewidth=0.25) +
  xlab("-log<sub>10</sub>P for Metabolite Set Enrichment") + ylab("") +
  ggplot_ms + 
  theme(legend.key.size = unit(0.35, "cm"),
        strip.background = element_blank(),
        strip.text.x = element_text(size=8, face="bold"),
        legend.title = element_blank(),
        strip.text = element_text(face="bold"),
        axis.title.x = element_markdown(size=8),
        axis.text.x = element_text(size=8, color="black"),
        axis.text.y = element_text(size=8, color="black")) 
plot_enrich_mmtt #%>% ggsave(filename="../output/fig_metab_OEA_byTimexGeno.pdf", height=3.5, width=7.5)

p %>% ggsave(filename="../output/fig_metab_OEA_byTimexGeno_top15.pdf", height=3, width=7.5)
```


## Primary bile acid associations

```{r}
# ==========================================================================
## Visualize major metabolites changing by genotype - boxplot for iAUC
# ==========================================================================

#signif_metabolites_geno <- lme_metab_mmtt %>% filter(p<.05/25) %>% 
#  rowwise() %>% mutate(Outcome = met_info$Name[met_info$HMDB == outcome])
#metab_geno <- signif_metabolites_geno %>% pull(Outcome)
#names(metab_geno) <- signif_metabolites_geno %>% pull(outcome)
  
scale_y_symmetric <- function(data, var, buffer = 0.05) {
  max_val <- max(abs(data[[var]]), na.rm = TRUE)
  max_val <- max_val * (1 + buffer)
  scale_y_continuous(limits = c(-max_val, max_val))
}

# Determine order for bileacids by strength
res_metab_mmtt_time_bygeno %>% filter(genotype == "HC genotype" & Outcome %in% bileacids) %>% arrange(p)

# Abbrevaited names for plotting
bileacids_abbrev <- c("GCDCA", "GDCA", "TDCA", "TCDCA") 
names(bileacids_abbrev) <- names(bileacids)


## All bileacids (not just those changing most for HC)
temp <- res_metab_mmtt_time_bygeno %>% 
  filter(outcome %in%  metabs.hc120[!metabs.hc120 %in% metabs.hf120] 
         & genotype == "HC genotype" & Time == "120 min") %>% 
  arrange(p) %>% 
  select(outcome, Outcome)

bileacids_all <- c(temp$Outcome[c(7,9,11,13,27,30,33,35)]) ; names(bileacids_all) <- c(temp$outcome[c(7,9,11,13,27,30,33,35)])
bileacids_all[c(8)] <- gsub(".*or ","",bileacids_all[c(8)])
bileacids_all_abbrev <- c("TCDCA", "TDCA", "GDCA", "GCDCA", "GCA", "TCA", "GUDCA", "TUDCA") ; names(bileacids_all_abbrev) <- names(bileacids_all)
```

```{r}
## Create dataframe with log(fold_change) for bile acid metabolites: FC = log(m120) - log(m0)
bileacids_fc.df <- lapply(names(bileacids_all), function(ba) {
  analysis2 %>% select(id, genotype, time, ba) %>%
    mutate_at("time", ~paste0("m", .)) %>%
    filter(time %in% c("m0", "m120")) %>%
    pivot_wider(names_from=time, values_from=ba) %>% 
    mutate(diff=m120-m0) %>%
    rename_with(., ~gsub("diff", ba, .)) %>%
    select(id, genotype, ba)
  }) %>% reduce(full_join, by=c("id", "genotype"))

# =================================
## Sumary-level data plots
# =================================
plot_ba120_mmtt <- bileacids_fc.df %>% 
  #select(id, genotype, names(bileacids_all)) %>%
  pivot_longer(names(bileacids_all)) %>% 
  mutate_at("name", ~bileacids_all_abbrev[name]) %>%
  group_by(genotype, name) %>% filter(!is.na(genotype)) %>%
  reframe(n=n(), mean=mean(exp(value)), sd=sd(exp(value))) %>% mutate(se=mean/sqrt(n)) %>%
  ggplot(aes(x=name, group=genotype, y=mean, ymin=mean-se, ymax=mean+se, color=genotype)) +
  #facet_wrap(~name, labeller = as_labeller(bileacids_all_abbrev), scales="fixed", nrow=1, strip.position="bottom") + 
  geom_hline(yintercept = 1, linewidth=0.25, color="black") +
  geom_point(size=2, position=position_dodge(0.35)) + geom_errorbar(width=0.15, linewidth=0.45, position=position_dodge(0.35)) +
  scale_color_manual(values=parameters$geno$palette, name=parameters$geno$label) + 
  scale_y_continuous(limits=c(0,16), breaks=c(1,5,10,15)) +
  theme_bw() + ggplot_ms + 
  ylab("120 min fold change") + xlab("") + 
  theme(#panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor.y = element_line(),
        axis.text.x = element_text(color="black", size=8, angle=35, hjust=1, vjust=1), 
        axis.title.y = element_text(color="black", size=10), 
        legend.position = "bottom",
        legend.margin = margin(1,1,1,1,"mm")
        #axis.ticks.x = element_blank()
       # axis.title.x = element_blank()#element_text(size=10)
        ) ; p

plot_ba120_mmtt %>% ggsave(filename="../output/fig_metab_bileacids_FC_byGeno_v2.pdf", height=3, width=4)
```

```{r}
# ============================================================
## Heat Map of Bile Acid levels and clinical metabolites
# ==============================================================
library(ComplexHeatmap)
library(circlize)
clinvars <- c("glucose", "insulin", "tg", "ldl", "hdl")
clinvars.lab <- c("Glucose", "Insulin", "TG", "LDL", "HDL")
names(clinvars.lab) <- clinvars

lm_ba_clin <- fread("../data/processed/tab_result_metab_clinvars_corr_pearson.csv") %>%
  filter(endsWith(ba, "120fc")) %>%
  filter(!grepl("iAUC", y) & !grepl("30",y), !grepl("180",y)) %>%
  #filter(endsWith(y, "120") | endsWith(y, "235")) %>%
  separate(y, into=c("outcome", "time"), sep="_") %>%
  mutate(exposure=bileacids_all_abbrev[gsub("_.*","",ba)]) %>%
  # Filter to only BA included above
  filter(gsub("_.*", "", ba) %in% names(bileacids_all))

hm_ba_clin <- lm_ba_clin %>% 
  arrange(p) %>%
  rowwise() %>% mutate(Outcome=factor(outcome, levels=c(clinvars), labels=c("Glucose", "Insulin","TG", "LDL", "HDL"))) %>%
  mutate(Outcome = paste0(Outcome, " at ", time, "min")) %>%
  rename(Exposure = exposure)

# Create heatmap matrix (beta values)
hm_df <- hm_ba_clin %>%
  select(Exposure, cor, Outcome) %>%
  pivot_wider(names_from = Outcome, values_from = cor) 

hm_mat <- as.matrix(hm_df %>% select(-Exposure))
rownames(hm_mat) <- hm_df$Exposure

# Draw once to get clustered row/column order
ht_base <- Heatmap(hm_mat,
                   cluster_rows = TRUE,
                   cluster_columns = TRUE)

ht_drawn <- draw(ht_base)
hm_rows <- row_order(ht_drawn)
hm_cols <- column_order(ht_drawn)

# Reorder the heatmap matrix
hm_plot <- hm_mat[hm_rows, hm_cols]

# Create matching p-value matrix with reordered rows/columns
hm_p <- hm_ba_clin %>%
  select(Exposure, Outcome, p) %>%
  pivot_wider(names_from = Exposure, values_from = p) %>%
  mutate(Outcome = factor(Outcome, levels = colnames(hm_plot))) %>%
  arrange(Outcome) %>%
  select(Outcome, rownames(hm_plot))

hm_p_mat <- as.matrix(hm_p %>% select(-Outcome))
rownames(hm_p_mat) <- hm_p$Outcome

# 6. Define cell_fun with correct indexing
cell_fun <- function(j, i, x, y, width, height, fill) {
  pval <- hm_p_mat[i, j]
  if (!is.na(pval)) {
    if (pval < 0.01) {
      grid.text("**", x, y, gp = gpar(fontsize = 10, fontface = "bold"))
    } else if (pval < 0.05) {
      grid.text("*", x, y, gp = gpar(fontsize = 10, fontface = "bold"))
    }
  }
}

#hm_palette <- colorRamp2(c(-2,0,2), c("blue", "white", "red"))
hm_palette <- colorRamp2(c(-0.7,0,0.7), c(palettes$NatExt$Greens[3], "white", palettes$NatExt$Purples[3]))

# Final plot with annotations in correct places
pdf("../output/fig_metab_hm_ba_clinvars_pearson_v3.pdf", height=5, width=3.25)
Heatmap(t(hm_plot),
        name = "beta",
        row_names_side = "left", row_names_gp = gpar(fontsize=8),
        column_names_side = "bottom", column_names_gp = gpar(fontsize=8),
        #column_names_rot = 45,
        cluster_rows = FALSE,
        cluster_columns = FALSE,
        cell_fun = cell_fun,
        #row_labels = c("TG", "HDL", "Insulin", "LDL", "Glucose"),
        col = hm_palette,
        height = unit(5,"cm"), width=unit(4,"cm"),
        heatmap_legend_param = list(title=""))
dev.off()
```


## Metabolomics analysis for self-selected meal

```{r}
lme_metab_ssmt_time_bymealxgeno <- fread("../data/processed/tab_result_lme_metab_ssmt_unadj_bymealxgeno_2.csv")
lme_metab_ssmt_time_bymeal <- fread("../data/processed/tab_result_lme_metab_ssmt_unadj_bymeal.csv")

res_metab_ssmt_time_bymealxgeno <- lme_metab_ssmt_time_bymealxgeno %>% 
  mutate(beta=beta/log(2)) %>%
  filter(Exposure == "Time_360") %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub("Time_", "", .), " min")) 

res_metab_ssmt_time_bymeal <- lme_metab_ssmt_time_bymeal %>% 
  mutate(beta=beta/log(2)) %>%
  filter(Exposure == "Time_360") %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub("Time_", "", .), " min")) 

## Metabolite Lists
hchc <- res_metab_ssmt_time_bymealxgeno %>% filter(genotype == "HC genotype" & meal_type == "HC meal") %>% filter(p<0.05/23) %>% arrange(p) %>% pull(outcome)
hfhc <- res_metab_ssmt_time_bymealxgeno %>% filter(genotype == "HF genotype" & meal_type == "HC meal") %>% filter(p<0.05/23) %>% arrange(p) %>% pull(outcome)
hchf <- res_metab_ssmt_time_bymealxgeno %>% filter(genotype == "HC genotype" & meal_type == "HF meal") %>% filter(p<0.05/23) %>% arrange(p) %>% pull(outcome)
hfhf <- res_metab_ssmt_time_bymealxgeno %>% filter(genotype == "HF genotype" & meal_type == "HF meal") %>% filter(p<0.05/23) %>% arrange(p) %>% pull(outcome)

## Counting UNIQUE metabolites in each group for MS
hchc.unq <- hchc[!hchc %in% hfhc] #%>% length() # 23 unique metabolites for HC/HC -- > now 8
hfhc.unq <- hfhc[!hfhc %in% hchc] #%>% length() # 101 unique metabolites for HF/HC --> now 34
hchf.unq <- hchf[!hchf %in% hfhf] #%>% length() # 120 unique metabolites for HC/HF --> now 5
hfhf.unq <- hfhf[!hfhf %in% hchf] #%>% length() # 4 unique metabolites for HF/HF --> now 8

## Intersection at each time point (metabolites changing in BOTH genotypes)
hc <- res_metab_ssmt_time_bymeal %>% filter(outcome %in% c(intersect(hchc, hfhc))) %>%
  arrange(p) %>% pull(outcome) 
hf <- res_metab_ssmt_time_bymeal %>% filter(outcome %in% c(intersect(hchf, hfhf))) %>%
  arrange(p) %>% pull(outcome) 

## Metabolite Labels - prioritize bile acid metabolites
hc.top20 <- hc[!hc %in% hf][1:20] ; hf.top20 <- hf[!hf %in% hc][1:20]

hchc.labs <- hchc.unq[c(which(hchc.unq %in% names(bileacids_all)),1:20)] # no change
hfhc.labs <- hfhc.unq[c(which(hfhc.unq %in% names(bileacids_all)),1:14)]
hchf.labs <- hchf.unq[c(which(hchf.unq %in% names(bileacids_all)),1:13)]
hfhf.labs <- hfhf.unq[c(which(hfhf.unq %in% names(bileacids_all)),1:4)] # only 4

## Revised metabolite labels: top 5 and all bile acids
hchc.labs <- c(hchc.unq[1:5], names(bileacids_all)) # no change
hfhc.labs <- c(hfhc.unq[1:5], names(bileacids_all))
hchf.labs <- c(hchf.unq[1:5], names(bileacids_all))
hfhf.labs <- c(hfhf.unq[1:5], names(bileacids_all))

```

```{r}

# All participants / HC and HF meals
#p_v.all_meals <- plot_volcano.fun(
#  res_metab_ssmt_time_bymeal %>%
#    mutate(Lab = ifelse(meal_type == "HC meal" & outcome %in% hc.top20, gsub(" &.*", "", Outcome), 
#                        ifelse(meal_type == "HF meal" & outcome %in% hf.top20, gsub(" &.*", "", Outcome), NA))),
#    #mutate(Lab2 = ifelse(Outcome %in% metabolites_geno.labs, Outcome, NA)),
#  add_labels = T, col1="#00000098", col2="#7F7F7F95", beta_threshold = 0.25) +
#  facet_grid(cols=vars(meal_type)) + 
#  theme(axis.title.x = element_blank(), 
#        plot.margin = margin(c(0,0,-0.1,0), unit="mm"),
#        axis.text.x = element_blank(),
#        axis.title.y = element_text(size=8),
#        axis.ticks.x = element_blank(),
#        #strip.text = element_blank()
#        ) +  
#  #geom_label_repel(aes(label=Lab2), label.padding = 0.05, box.padding = 0.05, nudge_y = 0.1, size=2, color="black", fontface="bold", fill=NA, label.size = 0, max.overlaps = 10) +
#  geom_text(data = data.frame(label="All participants (N = 22)", x=-8.35, y=20.65), aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
#  coord_cartesian(ylim=c(0,10), xlim=c(-6,10)) + 
#  scale_y_continuous(breaks=seq(0,10,2)) + scale_x_continuous(breaks=seq(-5,10,5)) ; p_v.all_meals
  

# HC genotype / HC and HF meals
p_v.hc_meals <- plot_volcano.fun(
  res_metab_ssmt_time_bymealxgeno %>% 
      mutate(Lab = ifelse(meal_type == "HC meal" & outcome %in% hchc.labs, gsub(" &.*", "", Outcome), 
                          ifelse(meal_type == "HF meal" & outcome %in% hchf.labs, gsub(" &.*", "", Outcome), NA))) %>% 
    #mutate(Lab2 = ifelse(Outcome %in% metabolites_geno.labs, Outcome, NA)) %>%
    filter(genotype == "HC genotype"), add_labels = T,
  col1=parameters$genotype$palette[[2]], col2=parameters$gene_x_meal$palette[2], #col1="#00000080", col2="#7F7F7F95",
  #col_unique = T, metab_unique = c(metabs.hc120, metabs.hc235), colUnq = "#E97132") +
  beta_threshold = 0.25) +
  facet_grid(cols=vars(meal_type)) + 
  theme(#plot.margin = margin(0.1,0.1,-0.1,0.1, unit="cm"),
        plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.y = element_text(size=8), #axis.ticks.y = element_blank(), #axis.text.y = element_blank(),
        strip.text = element_blank()
        ) + 
  geom_text(data = data.frame(label="HC genotype (N = 12)", x=-8.35, y=12.35), aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
  #geom_label_repel(aes(label=Lab2), label.padding = 0.05, box.padding = 0.05, nudge_y = 0.1, size=2, color="black", fontface="bold", fill=NA, label.size = 0, max.overlaps = 10) +
  coord_cartesian(ylim=c(0,5), xlim=c(-4,5.5)) + 
  scale_y_continuous(breaks=seq(0,8,2)) + scale_x_continuous(breaks=seq(-4,6,2)); p_v.hc_meals


# HF genotype / HC and HF meals
p_v.hf_meals <- plot_volcano.fun(
  res_metab_ssmt_time_bymealxgeno %>% #mutate(beta=beta/log(2)) %>% 
      mutate(Lab = ifelse(meal_type == "HC meal" & outcome %in% hfhc.labs, gsub(" &.*", "", Outcome), 
                          ifelse(meal_type == "HF meal" & outcome %in% hfhf.labs, gsub(" &.*", "", Outcome), NA))) %>% 
    filter(genotype == "HF genotype"), add_labels = T,
  col1=parameters$genotype$palette[[1]], col2=parameters$gene_x_meal$palette[3], 
  beta_threshold = 0.5) +
  facet_grid(cols=vars(meal_type)) +
  xlab("log<sub>2</sub> fold change from 0 min") + 
  theme(plot.margin = margin(c(-1,0,0,0), unit="line"),
        axis.title.x = element_markdown(), 
        axis.title.y = element_text(size=8),
        strip.text = element_blank()) + 
  geom_text(data = data.frame(label="HF genotype (N = 12)", x=-8.35, y=12.35), aes(x=x, y=y, label=label), inherit.aes = F, hjust=0, vjust=1, size=2, fontface="bold") + 
  #geom_label_repel(aes(label=Lab2), label.padding = 0.05, box.padding = 0.05, nudge_y = 0.1, size=2, color="black", fontface="bold", fill=NA, label.size = 0, max.overlaps = 10) +
  coord_cartesian(ylim=c(0,5), xlim=c(-4,5.5)) + 
  scale_y_continuous(breaks=seq(0,8,2)) + scale_x_continuous(breaks=seq(-4,6,2)); p_v.hf_meals

ggarrange(p_v.all_meals, p_v.hc_meals, p_v.hf_meals, nrow=3, legend = "none", heights=c(1.1,0.9,1.)) #%>%
  #ggsave(filename="../output/fig_metab_volcano_bymealxgeno_panel_labelsUnq_top20_v2.pdf", width=6, height=7.5)

pC<-ggarrange(p_v.hc_meals, p_v.hf_meals, nrow=3, legend = "none", heights=c(0.9,1.1)) #%>%
```


```{r}
### AUC
plot_iAUC_strat <- function(metabolite, iAUC=360, y_extend=c(0.15,0), iAUC_method=".pos", strata="genotype", panel="meal_choice", fancy_x=F, data=analysis) {
  strata_var=parameters[[strata]]$strata 
  #y_label=paste(str_to_sentence(metabolite), Unit, " 120-min iAUC")
  y_label=paste0(str_to_sentence(metabolite), ", 120 min iAUC")
  p <- data %>% select(id, starts_with(metabolite) & ends_with(paste0(iAUC,"iAUC.net")), strata=all_of(strata_var), panel=all_of(panel)) %>%
    rename_at(paste0(metabolite, "_", iAUC, "iAUC.net"), ~gsub(paste0("[_]", iAUC,"iAUC.*"), "", gsub(metabolite, "value", .))) %>%
    group_by(strata, panel) %>% filter(complete.cases(strata)) %>%
    reframe(n=n(), mean=mean(value), sd=sd(value)) %>% mutate(se=sd/sqrt(n)) %>%
    mutate_at("panel", ~factor(., levels=c("HC meal", "HF meal"))) %>%
    mutate_at("strata", ~factor(., levels=genotypes)) %>%
    
    ggplot(aes(x=strata, y=mean, ymin=mean-se, ymax=mean+se, fill=strata)) +
    facet_grid(cols=vars(panel)) +
    geom_bar(stat="identity") + geom_errorbar(width=0.075) +
    xlab(parameters[[strata]]$label) + ylab(y_label) + 
    scale_fill_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    theme_bw() + theme(axis.text.x = element_blank()) + 
    ggplot_ms + 
    theme(strip.background = element_blank(), strip.text=element_text(face="bold"))
    
    p <- ggplot_extend_ylim(p, y_max_extend=y_extend[1], y_extend[2])
    if(fancy_x == T) {
      p <- p + xlab("") + theme(axis.text.x = element_text(vjust=-0.5, color="black")) + 
        scale_x_discrete(labels = parameters[[strata]]$levels_fancy)
      } ; p
}


## PICK UP HERE CONFIRMING BA SPECIFICS ANDHOW TO CRETE REST OF THIS FIGURE*8

################
## Mega-Panel ##
################

## Meal choice & postprandial responses 
plot_geneXmeal <- ggarrange(
  plot_ppXtime_stratified_sum_panel("glucose", times=c(235,270,300,360), strata="genotype") +
    theme(axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank()), "",
  plot_ppXtime_stratified_sum_panel("insulin", times=c(235,270,300,360), strata="genotype") +
    theme(strip.text.x = element_blank()),
  align="hv", nrow=3, common.legend = T, legend = "none", widths = c(1.15,1), heights=c(1.1,-0.2,1))
plot_geneXmeal

pAB <- ggarrange(p_horiz, plot_geneXmeal, nrow=2, legend = "right", heights=c(0.35, 1.15), align="h") 
pAB %>% ggsave(filename="../output/fig_postprandial_ssmt_panel.pdf", width=6, height=6)

## 
plot_iAUC_geneXmeal <- ggarrange(
  plot_iAUC_strat("glucose", fancy_x = T), "", plot_iAUC_strat("insulin", fancy_x=T),
  align="hv", nrow=1, common.legend = T, legend = "none", widths = c(1.05,0.05, 1))
plot_iAUC_geneXmeal #%>% ggsave(filename="../output/fig_postprandial_smt_iauc_genexmeal.pdf", width=6.5, height=3)


## Metabolomics volcano plots
pC %>% ggsave(filename="../output/fig_metab_volcano_bymealxgeno_panel_labelsUnq_top20_wide.pdf", width=5.5, height=6)

```

## Descriptive Enrichment Plots

```{r}
# ====================================================================
## Descriptive enrichment plots 
# ====================================================================

# P <0.05/23 && B >0.05 -------------------
metab_sets <- rbind.data.frame(
  #fread("../data/metaboanalyst/oea/oea_peff_b05/oea_hc120/msea_ora_result.csv") %>% mutate(set="HC genotype @ 120 min"),
  fread("../data/metaboanalyst/oea/oea_p05_log2fc05_ssmt/hchc/msea_ora_result.csv") %>% mutate(set="HC genotype & HC meal"),
  fread("../data/metaboanalyst/oea/oea_p05_log2fc05_ssmt/hchf/msea_ora_result.csv") %>% mutate(set="HC genotype & HF meal"),
  fread("../data/metaboanalyst/oea/oea_p05_log2fc05_ssmt/hfhc/msea_ora_result.csv") %>% mutate(set="HF genotype & HC meal"),
  fread("../data/metaboanalyst/oea/oea_p05_log2fc05_ssmt/hfhf/msea_ora_result.csv") %>% mutate(set="HF genotype & HF meal")
  ) %>% rename(p="Raw p") %>%
  mutate(log10p=-log10(p)) %>%
  mutate(Metabolite.Set = factor(V1, levels = rev(unique(V1[order(p)])))) %>%
  mutate(genotype = gsub("[&].*", "", set),
        meal = gsub(".*[&] ", "", set)
        ) ; metab_sets

## Filter for only the top 10 pathways
to_plot <- c("Biosynthesis of unsaturated fatty acids", "Primary bile acid biosynthesis", "Starch and sucrose metabolism", 
             "Fructose and mannose metabolism", "Galactose metabolism", "Glysine, serine and threonine metabolism",
             "Fatty acid metabolism", "Linoleic acid metabolism", "Taurine and hypotaurine metabolism",
             "D-Amino acid metabolism", "Pentose phosphate pathway")

# Fill in missing combinations with 0
#complete_df <- left_join(expand_grid(V1 = to_plot, meal = c("HC meal", "HF meal"), genotype = c("HC genotype", "HF genotype")), 
#                           metab_sets %>% select(V1, Metabolite.Set, genotype, meal, log10p) %>% filter(V1 %in% to_plot), by = c("V1", "meal", "genotype"))

p <- metab_sets %>% 
  select(log10p, V1, Metabolite.Set, genotype, meal) %>%
  #filter(V1 %in% to_plot) %>%
  ggplot(aes(x=log10p, y=Metabolite.Set, fill = genotype, group = genotype)) + 
  facet_grid(~meal) + 
  theme_bw() + ggplot_ms + 
  geom_vline(xintercept = 0, linewidth=0.15, color="black") +
  geom_col(position = position_dodge(), width=0.75) + 
  scale_fill_manual(values=c("HC genotype "= parameters$genotype$palette[[2]], 
                             "HF genotype "= parameters$genotype$palette[[1]]),
                    name="Genotype") + 
  geom_vline(xintercept = -log10(.05), linetype="dashed", linewidth=0.25) +
  xlab("-log<sub>10</sub>P for Metabolite Set Enrichment") + ylab("") +
  ggplot_ms + 
  theme(legend.key.size = unit(0.35, "cm"),
        strip.background = element_blank(),
        strip.text.x = element_text(size=8, face="bold"),
        legend.title = element_blank(),
        strip.text = element_text(face="bold"),
        axis.title.x = element_markdown(size=8),
        axis.text.x = element_text(size=8, color="black"),
        axis.text.y = element_text(size=8, color="black")) ; p

p %>% ggsave(filename="../output/fig_metab_OEA_byMealxGeno_top10.pdf", height=2.25, width=7.5)
```


## Follow up on bile acid hypothesis at self-selected meal

```{r}

## NOTE: bile acids changing significantly for each genotype

# =================================
## Summary-level data plots
# =================================
p <- bileacids_fc_ssmt.df %>% 
  rename_with(., ~gsub("_.*","",.)) %>%
  #select(id, genotype, names(bileacids_all)) %>%
  pivot_longer(names(bileacids_all)) %>% 
  mutate_at("name", ~bileacids_all_abbrev[name]) %>%
  group_by(genotype, meal, name) %>% filter(!is.na(genotype)) %>%
  reframe(n=n(), mean=mean(exp(value)), sd=sd(exp(value))) %>% mutate(se=sd/sqrt(n)) %>%
  ggplot(aes(x=name, group=genotype, y=mean, ymin=mean-1.96*se, ymax=ifelse(mean+1.96*se>12.5,12,mean+1.96*se), color=genotype)) +
  facet_grid(rows = vars(meal)) + #, labeller = as_labeller(bileacids_all_abbrev), scales="fixed", nrow=1, strip.position="bottom") + 
  geom_hline(yintercept = 1, linewidth=0.25, color="black") +
  geom_point(size=1.25, position=position_dodge(0.35)) + 
  geom_errorbar(width=0.15, linewidth=0.45, position=position_dodge(0.35), ) +
  scale_color_manual(values=parameters$genotype$palette, name=parameters$genotype$label) + 
  scale_y_continuous(limits=c(-5,12.5), breaks=seq(-5,12,3)) +
  theme_bw() + ggplot_ms + 
  ylab("120 min fold change") + xlab("") + 
  theme(#panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor.y = element_line(),
        axis.text.x = element_text(color="black", size=8, angle=35, hjust=1, vjust=1), 
        axis.title.y = element_text(color="black", size=10), 
        legend.position = "none",
        legend.margin = margin(1,1,1,1,"mm")
        #axis.ticks.x = element_blank()
       # axis.title.x = element_blank()#element_text(size=10)
        ) ; p

p %>% ggsave(filename="../output/fig_metab_bileacids_FC_byGenoxMeal.pdf", height=2.5, width=4)

```


```{r}
# ==========================================================================
## Visualize major metabolites changing by genotype - boxplot for iAUC
# ==========================================================================

signif_metabolites_geno <- lme_metab_mmtt %>% filter(p<.05/25) %>% 
  rowwise() %>% mutate(Outcome = met_info$Name[met_info$HMDB == outcome])
metab_geno <- signif_metabolites_geno %>% pull(Outcome)
names(metab_geno) <- signif_metabolites_geno %>% pull(outcome)
  
scale_y_symmetric <- function(data, var, buffer = 0.05) {
  max_val <- max(abs(data[[var]]), na.rm = TRUE)
  max_val <- max_val * (1 + buffer)
  scale_y_continuous(limits = c(-max_val, max_val))
}

## Plot of differences in 235 iAUC for metabolites x genotype
plot_iAUC_metab_box <- function(metabolites=metab_geno, data, strata="genotype") {
 data %>%
    select(id, genotype, paste0(names(metab_geno), "_235iAUC.net")) %>%
    filter(genotype != "") %>% 
    rename_with(., ~gsub("_235iAUC.net", "", .)) %>%
    pivot_longer(names(metabolites)) %>% 
    mutate_at("name", ~factor(., levels=c(names(metab_geno)[c(3,2,1,4,5)]))) %>%
    #filter(name %in% c("HMDB0008993", "HMDB0007102", "HMDB0007216")) %>%
    #group_by(genotype, name) %>% filter(complete.cases(genotype)) %>%
    #reframe(n=n(), mean=mean(value, na.rm=T), sd=sd(value, na.rm=T)) %>% mutate(se=sd/sqrt(n)) %>% 
    
    ggplot(aes(x=genotype, y=value, fill=genotype, color=genotype)) + 
    facet_wrap(~name, labeller = as_labeller(metab_geno), scales="fixed", nrow=1, strip.position="bottom") +
    geom_hline(yintercept = 0, linewith=0.55) +
    geom_boxplot(outlier.shape=NA, width=0.55, alpha=0.25, color="black") + 
    geom_jitter(width=0.2, size=1.55) +
    xlab(parameters[[strata]]$label) + ylab("235 min iAUC") + 
    scale_fill_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    scale_color_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    theme_bw() + #theme(axis.text.x = element_blank()) + 
    ggplot_ms + 
    scale_x_discrete(labels=c("HC genotype"="HC", "HF genotype"="HF")) +
    scale_y_continuous(expand=expansion(mult = c(0.1,0.1))) +
    theme(strip.background = element_blank(), strip.text=element_text(face="bold"),
          panel.border = element_blank(),
          panel.background = element_blank(),
          axis.text.x = element_blank(), axis.ticks.x = element_blank(),
          axis.title.x = element_blank()#element_text(size=10)
          )
}

plot_iAUC_metab_box(metabolites=metab_geno, data=fread("../data/processed/dat_metab_iauc_mmtt_top20.csv")) %>% 
  ggsave(filename="../output/fig_metabolomics_iauc_metab_geno.pdf", height=3.5, width=6.5)

## Panels by magnitude vs direction
ggarrange(
  plot_iAUC_metab_box(metabolites=metab_geno[c(5,3)], data=fread("../data/processed/dat_metab_iauc_mmtt_top20.csv")),
  plot_iAUC_metab_box(metabolites=metab_geno[c(1:2,4)], data=fread("../data/processed/dat_metab_iauc_mmtt_top20.csv")),
  common.legend = T, widths=c(0.75,1))  %>% 
  ggsave(filename="../output/fig_metabolomics_235iauc_metab_geno_mag&dir.pdf", height=4, width=6)
```

Stratified associations of significant metabolites with glycemic/lipid factors by genotype

```{r, fig.width=12, fig.height=4}
metab_geno_clinvars_metabxtime_bygeno %>%
  filter(grepl("joint", Exposure)==F) %>%
  mutate(time=gsub(".*time", "", Exposure)) %>%
  select(genotype, Metabolite, Outcome, time, beta, lowCI, upCI) %>%
  #filter(Metabolite == metab_geno[m]) %>% 
  mutate(outcome_time = paste0(Outcome, " at ", time)) %>%
    filter(outcome_time %in% c("glucose at 120", "insulin at 120", "tg at 235", "hdl at 235", "ldl at 235")) %>%
    mutate_at("outcome_time", ~factor(., levels=c("glucose at 120", "insulin at 120", "tg at 235", "hdl at 235", "ldl at 235"),
                                    labels=c("Glucose at 120", "Insulin at 120", "TG at 235", "HDL at 235", "LDL at 235"))) %>%
  ggplot(aes(x=beta, xmin=lowCI, xmax=upCI, y=Metabolite, color=genotype)) + 
  theme_bw() + ggplot_ms + 
  facet_grid(~outcome_time, scale="free_x") +
  geom_vline(xintercept = 0) + 
  geom_point(size=1.5, position=position_dodge(0.35)) + 
  geom_errorbar(width=0.35, position=position_dodge(0.35)) + 
    scale_x_continuous(expand=expansion(0.2,0.2)) +
  scale_color_manual(values=parameters$genotype$palette, name=parameters$genotype$label) + 
  theme(strip.background = element_blank(), strip.text = element_text(face="bold")) 

p #%>% ggsave(filename="../output/fig_metab_lme_clin_metab_geno_panel.pdf", height=4, width=10)

```




```{r}
## Check Volcano plots for adjusted models
lme_metab_mmtt_adj <- fread("../data/processed/tab_result_lme_metab_postpran_mmtt_adj.csv") %>%
  mutate_at("Exposure", ~gsub(".*Genotype_", "HC Genotype", .)) %>% 
  filter(Exposure != "HC Genotype x time(joint)") %>%
  filter(Effect != "Main" & !is.na(beta)) %>%
  mutate(Outcome=gsub("_.*", "", outcome)) %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub(".*time", "0 vs. ", .), " min")) 

lme_metab_mmtt_adj_prim <- lme_metab_mmtt_adj %>% filter(model=="primary")
lme_metab_mmtt_adj_bmi <- lme_metab_mmtt_adj %>% filter(model=="bmi")

plot_volcano.fun(lme_metab_mmtt_adj_prim, p_eff=25, add_labels = T) + coord_cartesian(ylim=c(0,3.5), xlim=c(-1.25,1.25)) 
plot_volcano.fun(lme_metab_mmtt_adj_bmi, p_eff=25, add_labels = T) + coord_cartesian(ylim=c(0,3.5), xlim=c(-1.25,1.25)) +
  xlab("Beta coefficient for HC vs HF meal") 

## NO change in estimates when adding adjustment 
lme_metab_mmtt %>% filter(p<0.05/25) %>% arrange(p)
lme_metab_mmtt_adj_prim %>% filter(p<0.05/25)%>% arrange(p)
lme_metab_mmtt_adj_bmi %>% filter(p<0.05/25)%>% arrange(p)

# example: no change in effect estimate with adjustment
summary(lmerTest::lmer(HMDB0009069~genotype*time+(1|id), data=analysis2 %>% filter(time %in% c(0, 120, 235))))
summary(lmerTest::lmer(HMDB0009069~genotype*time+(1|id)+age+sex+PC1z+PC2z+PC3z, data=analysis2 %>% filter(time %in% c(0, 120, 235))))
summary(lmerTest::lmer(HMDB0009069~genotype*time+(1|id)+age+sex+PC1z+PC2z+PC3z+bmi, data=analysis2 %>% filter(time %in% c(0, 120, 235))))
```

Represented pathways among significant metabolites
* HMDB0007216: DG(18:1(9Z)/18:0/0:0)  - Lipids:Glycerolipids:Diradylglycerols
* HMDB0240676: SM(d16:2(4E,8Z)/23:0) - Organic nutrogen compounds: Quaternary ammonium salts (Sphyngomyelin)
* HMDB0004949

```{r}
metab_dict %>% filter(Input.name %in% names(metab_geno))
met_info %>% filter(HMDB %in% names(metab_geno))
metabclass %>% filter(HMDB %in% names(metab_geno))

## Spotlight on PE 36:1
lme_metab_mmtt %>% filter(outcome == "HMDB0008993")
anova(lmerTest::lmer(HMDB0008993~genotype*time+(1|id), data=analysis2 %>% filter(time %in% c(0,120,235))))
```



## Self-Selected Mixed Meal ****

```{r}
# ==========================================================
# Volcano for metabolite changes over time x genotype
# ==========================================================

lme_metab_ssmt <- fread("../data/processed/tab_result_lme_metab_ssmt_unadj.csv") %>% 
  filter(Exposure != "HF meal x Time_(joint)") %>%
  rename(Time=Exposure) %>%
  mutate_at("Time", ~paste0(gsub(".*Time_", "0 vs. ", .), " min")) #%>%
  #filter(outcome %in% metabolites_pp)

p.l <- lapply(genotypes, function(g) {
  plot_volcano.fun(lme_metab_ssmt %>% mutate(beta=-beta/log(2)) %>%
                     #mutate(Time=g) %>%
                   filter(genotype == g), # switch to reference as HF *******
                 add_labels = F, beta_threshold = 0.3) + 
  coord_cartesian(ylim=c(0,3.75), xlim=c(-2.75,3.75)) + 
  theme(legend.position="right", legend.key.size = unit(0.35, "cm"),
        legend.title = element_blank(), legend.text = element_text(size=8)) + 
  xlab("Beta coefficient for HC vs HF (ref) meal\nof log2 fold change from 235 min")
})

## Panels by time
pdf("../output/fig_metabolomics_volcano_ssmt_mealchoice_byGeno_temp.pdf", height=3.5, width=8.5) #height=4, width=6.5
ggarrange(plotlist=p.l, common.legend = T, legend = "right")
dev.off()
```

```{r}
## Plot of significant metabolite differences in 235 to 360 iAUC by meal type

plot_iAUC_metab_ssmt_box <- function(metab.lab=metab_meal, data, strata="gene_x_meal") {
 data %>%
    select(id, meal_choice, genotype, paste0(names(metab.lab), "_360iAUC.net")) %>%
    filter(genotype != "") %>% 
    rename_with(., ~gsub("_360iAUC.net", "", .)) %>%
    pivot_longer(names(metab.lab)) %>% 
    mutate_at("name", ~factor(., levels=c(names(metab.lab)))) %>%
    mutate(genetic_cat_x_meal_choice = paste0(genotype, "\nx ", meal_choice)) %>%
    filter(genetic_cat_x_meal_choice %in% c("HC genotype\nx HC meal", "HC genotype\nx HF meal")) %>%
    
    ggplot(aes(x=genetic_cat_x_meal_choice, y=value, fill=genetic_cat_x_meal_choice, color=genetic_cat_x_meal_choice)) + 
    facet_wrap(~name, labeller = as_labeller(metab.lab), scales="fixed", nrow=1, strip.position="bottom") +
    geom_hline(yintercept = 0, linewith=0.55) +
    geom_boxplot(outlier.shape=NA, width=0.55, alpha=0.25, color="black") + 
    geom_jitter(width=0.2, size=1.55) +
    xlab(parameters[[strata]]$label) + ylab("235 min iAUC") + 
    scale_fill_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    scale_color_manual(values=parameters[[strata]]$palette, name=parameters[[strata]]$label) + 
    theme_bw() + #theme(axis.text.x = element_blank()) + 
    ggplot_ms + 
    scale_x_discrete(labels=c("HC genotype"="HC", "HF genotype"="HF")) +
    scale_y_continuous(expand=expansion(mult = c(0.1,0.1))) +
    theme(strip.background = element_blank(), strip.text=element_text(face="bold"),
          panel.border = element_blank(),
          panel.background = element_blank(),
          axis.text.x = element_blank(), axis.ticks.x = element_blank(),
          axis.title.x = element_blank()#element_text(size=10)
          )
}

metab_meal <- lme_metab_ssmt %>% filter(p<0.05/23) %>% pull(Outcome)
names(metab_meal) <- lme_metab_ssmt %>% filter(p<0.05/23) %>% pull(outcome)

ggarrange(
  plot_iAUC_metab_box(metab.lab=metab_meal, data=fread("../data/processed/dat_metab_iauc_ssmt_top20.csv")),
  plot_iAUC_metab_box(metab.lab=metab_meal, data=fread("../data/processed/dat_metab_iauc_ssmt_top20.csv")),
  common.legend = T, widths=c(0.75,1)) 

```




















##### MEGA FIGURE FOR MAT MET BRIEF COMMUNICATIONS

```{r}

A <- ggarrange("", p_glu_geno_indiv, "", p_insu_geno_indiv, common.legend = T, legend = "top",
          nrow=1, widths=c(0.05,1,0.05,1), labels=c("", "a", "", ""), hjust=0.85,
          vjust=0.8, font.label = c(size=16)) 
B <- ggarrange("", plot_iAUC_geno.l[[1]],"",plot_iAUC_geno.l[[2]], common.legend = T, legend = "none",
          nrow=1, widths=c(0.05,1,0.05,1), labels=c("", "b", "", ""), hjust=0.85,
          vjust=1.35, font.label = c(size=16))
AB <- ggarrange(A,"", B, ncol=1, align="h", heights=c(1.15, 0.05,1)) #; AB %>% ggsave(filename="../output/fig_briefcomms_fig2_ab.pdf", width=8, height=7.5)

ABC <- ggarrange(ggarrange("",AB,nrow=2,heights=c(0.05,1)), "", ggarrange(plot_volc_mmtt,"",nrow=2, heights=c(1,0.0)), align = "hv", nrow=1, widths=c(1.1,0.05,0.9)) 
ABC %>%   ggsave(filename="../output/fig_briefcomms_fig2_abc.pdf", height=6.5, width=11)

ggarrange(plot_enrich_mmtt, ggarrange(plot_ba120_mmtt, "", widths=c(0.75,0.25), nrows=1), nrows=2)

#fig_metab_OEA_byTimexGeno_top15.pdf
#fig_metab_bileacids_FC_byGeno_v2.pdf
#fig_metab_volcano_bygeno_panel_labelsUnq_top20.pdf
#C1 <- ggarrange(p_v.all, p_v.hc, p_v.hf, ncol=1, common.legend = F, legend = "none", heights=c(1.1,0.9,1.)) 

```


#### End of file

